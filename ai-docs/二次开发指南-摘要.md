# Res-Downloader 二次开发指南 - 快速摘要

> 本文档为二次开发指南的快速参考版本,包含最核心的信息。

---

## 📚 文档列表

| 文档 | 说明 |
|------|------|
| [DEV_INDEX.md](./DEV_INDEX.md) | 📖 **总索引** - 从这里开始 |
| [DEV_GUIDE.md](./DEV_GUIDE.md) | 🚀 **总体架构** - 项目全景视图 |
| [DEV_PLUGIN_DEV.md](./DEV_PLUGIN_DEV.md) | 🔌 **插件开发** - 如何添加新平台支持 |
| [DEV_API_REFERENCE.md](./DEV_API_REFERENCE.md) | 📡 **API 参考** - 所有接口文档 |
| [DEV_DEPLOYMENT.md](./DEV_DEPLOYMENT.md) | 📦 **发布部署** - 编译打包指南 |
| [DEV_TROUBLESHOOTING.md](./DEV_TROUBLESHOOTING.md) | 🐛 **问题排查** - 常见问题解决 |

---

## 🏗️ 项目核心架构

```
用户浏览器 → 系统代理 (127.0.0.1:8899) → goproxy 服务器
                                              ↓
                                         Plugin 插件
                                         (根据域名匹配)
                                              ↓
                                       提取资源 URL
                                              ↓
                                    WebSocket 推送到前端
                                              ↓
                                     Vue 界面展示列表
                                              ↓
                                        用户点击下载
                                              ↓
                                    Go 多线程下载器
                                              ↓
                                        保存到本地
```

---

## 📁 核心文件说明

### Go 后端

| 文件 | 作用 | 修改优先级 |
|------|------|-----------|
| `core/plugins/` | 平台插件 | ⭐⭐⭐ |
| `core/http.go` | API 接口 | ⭐⭐ |
| `core/proxy.go` | 代理核心 | ⭐ |
| `core/downloader.go` | 下载器 | ⭐ |
| `core/config.go` | 配置管理 | ⭐ |

### Vue 前端

| 文件 | 作用 | 修改优先级 |
|------|------|-----------|
| `frontend/src/views/index.vue` | 主页面 | ⭐⭐⭐ |
| `frontend/src/components/` | 组件库 | ⭐⭐ |
| `frontend/src/api/app.ts` | API 调用 | ⭐⭐ |

---

## 🚀 快速开始

### 1. 环境准备

```bash
# 安装依赖
go install github.com/wailsapp/wails/v2/cmd/wails@latest
cd frontend && npm install && cd ..

# 启动开发模式
wails dev
```

### 2. 添加新平台支持

```go
// 创建文件: core/plugins/plugin.example.com.go
package plugins

type ExamplePlugin struct {
    bridge *shared.Bridge
}

func (p *ExamplePlugin) Domains() []string {
    return []string{"example.com"}
}

func (p *ExamplePlugin) OnResponse(resp *http.Response, ctx *goproxy.ProxyCtx) *http.Response {
    // 提取资源逻辑
    url := resp.Request.URL.String()
    mediaInfo := shared.MediaInfo{
        Url:      url,
        Classify: "video",
        // ...
    }
    p.bridge.Send("newResources", mediaInfo)
    return nil
}
```

```go
// 注册插件: core/proxy.go 的 init() 函数
ps := []shared.Plugin{
    &plugins.QqPlugin{},
    &plugins.ExamplePlugin{},  // 新增
    &plugins.DefaultPlugin{},
}
```

### 3. 构建发布

```bash
# 单平台
wails build

# 跨平台
wails build -platform windows/amd64
wails build -platform darwin/arm64
wails build -platform linux/amd64
```

---

## 🔧 核心概念

### 1. Plugin 插件

插件是平台适配的核心,每个插件负责处理特定域名:

```go
type Plugin interface {
    SetBridge(*Bridge)
    Domains() []string
    OnRequest(req, ctx) (req, resp)
    OnResponse(resp, ctx) resp
}
```

### 2. Bridge 桥接器

Bridge 提供插件所需的核心能力:

```go
bridge.Send("newResources", mediaInfo)        // 发送资源
bridge.GetResType("video")                    // 检查类型
bridge.MediaIsMarked(urlSign)                 // 防重复
bridge.GetConfig("SaveDirectory")             // 读配置
```

### 3. 事件驱动

后端通过 WebSocket 推送事件到前端:

```typescript
// 前端监听
eventStore.addHandle({
    type: "newResources",
    event: (res) => {
        data.value.push(res)
    }
})
```

---

## 📊 数据流向

### 资源捕获流程

```
用户访问视频网站
    ↓
goproxy 拦截 HTTPS 请求 (MITM)
    ↓
Plugin.OnResponse() 处理响应
    ↓
检查 Content-Type → 判断资源类型
    ↓
提取 URL、封面、描述等信息
    ↓
构建 MediaInfo 结构体
    ↓
bridge.Send("newResources", mediaInfo)
    ↓
前端收到事件 → 展示在列表中
```

### 下载流程

```
用户点击下载按钮
    ↓
前端调用 POST /api/download
    ↓
resourceOnce.download() 启动下载
    ↓
downloader.Start() 多线程下载
    ↓
通过 WebSocket 推送进度
    ↓
下载完成 → 更新 SavePath
```

---

## 🐛 常见问题速查

### HTTPS 资源无法拦截?

**原因**: CA 证书未安装或域名未加入 MITM 规则

**解决**:
1. 访问 `http://127.0.0.1:8899/api/cert` 下载证书
2. 安装到系统信任库
3. 检查 `core/rule.go` 的 `shouldMitm` 逻辑

### 前端收不到事件?

**解决**:
1. 确保调用了 `eventStore.init()`
2. 检查事件类型拼写
3. 查看浏览器控制台错误

### 下载速度慢?

**解决**:
1. 增加线程数: 配置 `TaskNumber`
2. 启用上游代理: 配置 `UpstreamProxy`
3. 检查服务器限速

---

## 🎯 开发建议

### ✅ 推荐做法

1. **轻量级插件**: 只做资源提取,不处理下载
2. **防重复**: 使用 `MediaIsMarked` + `MarkMedia`
3. **错误隔离**: 插件错误不应影响代理服务
4. **配置驱动**: 通过配置控制行为

### ❌ 避免做法

1. 在插件中阻塞操作(网络请求、文件 I/O)
2. 修改全局变量
3. 硬编码域名,使用 `Domains()` 声明
4. 忽略 `Content-Type` 检查

---

## 📚 学习路径

### 初学者

1. 阅读 [DEV_GUIDE.md](./DEV_GUIDE.md) 了解整体架构
2. 运行 `wails dev` 启动项目
3. 查看 `core/plugins/plugin.qq.com.go` 学习插件示例

### 中级开发者

1. 阅读 [DEV_PLUGIN_DEV.md](./DEV_PLUGIN_DEV.md) 学习插件开发
2. 尝试添加一个简单的平台支持
3. 阅读 [DEV_API_REFERENCE.md](./DEV_API_REFERENCE.md) 了解 API

### 高级开发者

1. 研究 `core/proxy.go` 的代理核心逻辑
2. 优化 `core/downloader.go` 的下载性能
3. 阅读 [DEV_DEPLOYMENT.md](./DEV_DEPLOYMENT.md) 学习跨平台编译

---

## 🔗 相关资源

- [Wails 官方文档](https://wails.io/docs/introduction)
- [goproxy 项目](https://github.com/elazarl/goproxy)
- [GitHub 仓库](https://github.com/putyy/res-downloader)
- [在线文档](https://res.putyy.com/)

---

## 💬 获取帮助

- 📮 [GitHub Issues](https://github.com/putyy/res-downloader/issues)
- 💬 [爱享论坛](https://s.gowas.cn/d/4089)
- 📦 [交流群](https://www.putyy.com/app/admin/upload/img/20250418/6801d9554dc7.webp)

---

**文档版本**: v3.1.3
**最后更新**: 2026-01-28
