# res-downloader é¡¹ç›®æ·±åº¦åˆ†ææŠ¥å‘Š

> **ç‰ˆæœ¬**: 1.0
> **ç”Ÿæˆæ—¥æœŸ**: 2026-01-27
> **é¡¹ç›®ç‰ˆæœ¬**: åŸºäºæœ€æ–°ä»£ç 
> **åˆ†æèŒƒå›´**: å®Œæ•´æ¶æ„ + æ ¸å¿ƒå®ç° + äºŒæ¬¡å¼€å‘æŒ‡å—

---

## ç›®å½•

- [ä¸€ã€é¡¹ç›®æ¦‚è¿°](#ä¸€é¡¹ç›®æ¦‚è¿°)
- [äºŒã€æŠ€æœ¯æ ˆè¯¦è§£](#äºŒæŠ€æœ¯æ ˆè¯¦è§£)
- [ä¸‰ã€æ•´ä½“æ¶æ„è®¾è®¡](#ä¸‰æ•´ä½“æ¶æ„è®¾è®¡)
- [å››ã€æ ¸å¿ƒæ¨¡å—æ·±åº¦è§£æ](#å››æ ¸å¿ƒæ¨¡å—æ·±åº¦è§£æ)
- [äº”ã€å‰ç«¯æ¶æ„è¯¦è§£](#äº”å‰ç«¯æ¶æ„è¯¦è§£)
- [å…­ã€å®Œæ•´æ•°æ®æµåˆ†æ](#å…­å®Œæ•´æ•°æ®æµåˆ†æ)
- [ä¸ƒã€äºŒæ¬¡å¼€å‘æŒ‡å—](#ä¸ƒäºŒæ¬¡å¼€å‘æŒ‡å—)
- [å…«ã€å…³é”®æ–‡ä»¶é€ŸæŸ¥è¡¨](#å…«å…³é”®æ–‡ä»¶é€ŸæŸ¥è¡¨)
- [ä¹ã€å¼€å‘ç¯å¢ƒæ­å»º](#ä¹å¼€å‘ç¯å¢ƒæ­å»º)
- [åã€å¸¸è§é—®é¢˜è§£ç­”](#åå¸¸è§é—®é¢˜è§£ç­”)

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®ç®€ä»‹

**res-downloader** æ˜¯ä¸€æ¬¾åŸºäº **Wails v2** æ¡†æ¶å¼€å‘çš„è·¨å¹³å°æ¡Œé¢åº”ç”¨ï¼Œé›†æˆäº†ç½‘ç»œèµ„æºå—…æ¢ä¸é«˜é€Ÿä¸‹è½½åŠŸèƒ½ã€‚è¯¥åº”ç”¨é€šè¿‡æœ¬åœ°ä»£ç†æœåŠ¡å™¨æ‹¦æˆªç½‘ç»œæµé‡ï¼Œè‡ªåŠ¨æ£€æµ‹å¹¶æ•è·åª’ä½“èµ„æºï¼ˆè§†é¢‘ã€éŸ³é¢‘ã€å›¾ç‰‡ï¼‰ï¼Œæ”¯æŒå¤šçº¿ç¨‹å¹¶å‘ä¸‹è½½ï¼Œä¸ºç”¨æˆ·æä¾›ä¾¿æ·çš„èµ„æºä¸‹è½½ä½“éªŒã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- ğŸ” **æ™ºèƒ½å—…æ¢**ï¼šè‡ªåŠ¨æ£€æµ‹ç½‘ç»œæµé‡ä¸­çš„åª’ä½“èµ„æº
- ğŸš€ **é«˜é€Ÿä¸‹è½½**ï¼šå¤šçº¿ç¨‹å¹¶å‘ä¸‹è½½ï¼Œå……åˆ†åˆ©ç”¨å¸¦å®½
- ğŸ” **HTTPS æ”¯æŒ**ï¼šMITMï¼ˆä¸­é—´äººï¼‰æŠ€æœ¯è§£å¯† HTTPS æµé‡
- ğŸ§© **æ’ä»¶åŒ–æ¶æ„**ï¼šå¯æ‰©å±•çš„æ’ä»¶ç³»ç»Ÿï¼Œæ”¯æŒå®šåˆ¶åŒ–åŸŸåå¤„ç†
- ğŸ¨ **ç°ä»£åŒ– UI**ï¼šåŸºäº Vue 3 + Naive UI çš„ç¾è§‚ç•Œé¢
- ğŸŒ **è·¨å¹³å°**ï¼šæ”¯æŒ Windowsã€macOSã€Linux

### 1.2 æ ¸å¿ƒåŠŸèƒ½

#### (1) ä»£ç†æœåŠ¡å™¨
- ç›‘å¬æœ¬åœ°ç«¯å£ï¼ˆé»˜è®¤ 8899ï¼‰æ¥æ”¶ä»£ç†è¯·æ±‚
- æ”¯æŒ HTTP/HTTPS æµé‡æ‹¦æˆª
- MITM æŠ€æœ¯è§£å¯† HTTPS æµé‡
- åŸºäºè§„åˆ™çš„æ™ºèƒ½åŸŸåè¿‡æ»¤

#### (2) èµ„æºæ£€æµ‹ç³»ç»Ÿ
- å®æ—¶åˆ†æå“åº” Content-Type
- æ”¯æŒ 180+ MIME ç±»å‹è¯†åˆ«
- URL MD5 ç­¾åå»é‡æœºåˆ¶
- è‡ªåŠ¨åˆ†ç±»ï¼ˆvideo/audio/image/doc ç­‰ï¼‰

#### (3) å¤šçº¿ç¨‹ä¸‹è½½å¼•æ“
- å¯é…ç½®å¹¶å‘æ•°ï¼ˆé»˜è®¤ CPU æ ¸å¿ƒæ•° Ã— 2ï¼‰
- åŸºäº HTTP Range çš„åˆ†ç‰‡ä¸‹è½½
- æ–­ç‚¹ç»­ä¼ æ”¯æŒ
- è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
- æ™ºèƒ½é™çº§ï¼ˆå¤šçº¿ç¨‹å¤±è´¥è‡ªåŠ¨åˆ‡æ¢å•çº¿ç¨‹ï¼‰

#### (4) æ’ä»¶ç³»ç»Ÿ
- åŸŸåç‰¹å®šçš„èµ„æºå¤„ç†é€»è¾‘
- Bridge æ¨¡å¼è§£è€¦æ’ä»¶ä¸æ ¸å¿ƒ
- æ”¯æŒè¯·æ±‚/å“åº”æ‹¦æˆª
- å¯æ‰©å±•çš„æ’ä»¶æ³¨å†Œæœºåˆ¶

### 1.3 æŠ€æœ¯äº®ç‚¹

| æŠ€æœ¯ç‚¹ | å®ç°æ–¹å¼ | ä¼˜åŠ¿ |
|--------|----------|------|
| **HTTPS MITM** | è‡ªç­¾å CA è¯ä¹¦ + goproxy | æ— éœ€ç ´è§£åº”ç”¨ï¼Œç›´æ¥æ‹¦æˆªæµé‡ |
| **æ’ä»¶åŒ–æ¶æ„** | æ¥å£ + Bridge æ¨¡å¼ | ä½è€¦åˆã€æ˜“æ‰©å±•ã€é¿å…å¾ªç¯ä¾èµ– |
| **å¹¶å‘ä¸‹è½½** | goroutines + Range è¯·æ±‚ | å……åˆ†åˆ©ç”¨å¸¦å®½ï¼Œæå‡ä¸‹è½½é€Ÿåº¦ |
| **äº‹ä»¶é©±åŠ¨** | Wails Events ç³»ç»Ÿ | å‰åç«¯å®æ—¶é€šä¿¡ï¼Œæ— è½®è¯¢å¼€é”€ |
| **è§„åˆ™å¼•æ“** | é€šé…ç¬¦ + å¦å®šè§„åˆ™ | çµæ´»çš„ MITM åŸŸåè¿‡æ»¤ |
| **çƒ­æ›´æ–°é…ç½®** | JSON æŒä¹…åŒ– + åˆå¹¶ç­–ç•¥ | é…ç½®å˜æ›´å³æ—¶ç”Ÿæ•ˆ |

### 1.4 åº”ç”¨åœºæ™¯

- **å¾®ä¿¡è§†é¢‘å·**ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶ä¸‹è½½è§†é¢‘å·ä¸­çš„è§†é¢‘å’Œå›¾ç‰‡
- **æŠ–éŸ³/TikTok**ï¼šæ‹¦æˆªå¹¶ä¸‹è½½çŸ­è§†é¢‘èµ„æº
- **å¿«æ‰‹**ï¼šæ•è·å¿«æ‰‹å¹³å°çš„åª’ä½“å†…å®¹
- **å…¶ä»–å¹³å°**ï¼šé€šè¿‡æ’ä»¶æ‰©å±•æ”¯æŒä»»æ„å¹³å°

---

## äºŒã€æŠ€æœ¯æ ˆè¯¦è§£

### 2.1 åç«¯æŠ€æœ¯æ ˆ (Go)

| æŠ€æœ¯/åº“ | ç‰ˆæœ¬ | ç”¨é€” |
|---------|------|------|
| **Wails** | v2.10.1 | æ¡Œé¢åº”ç”¨æ¡†æ¶ï¼Œæä¾› Go ä¸å‰ç«¯æ¡¥æ¥ |
| **goproxy** | latest | HTTP/HTTPS ä»£ç†åº“ï¼Œå®ç° MITM |
| **zerolog** | latest | ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ |
| **æ ‡å‡†åº“** | Go 1.22+ | net/http, context, sync, crypto ç­‰ |

**æ ¸å¿ƒä¾èµ–åˆ†æ**ï¼š

```go
// go.mod å…³é”®ä¾èµ–
require (
    github.com/wailsapp/wails/v2 v2.10.1     // Wails æ¡†æ¶
    github.com/elazarl/goproxy                // ä»£ç†æ ¸å¿ƒ
    github.com/rs/zerolog                      // æ—¥å¿—
    github.com/vrischmann/userdir              // ç”¨æˆ·ç›®å½•
    github.com/matoous/go-nanoid/v2            // ID ç”Ÿæˆ
)
```

### 2.2 å‰ç«¯æŠ€æœ¯æ ˆ (Vue.js)

| æŠ€æœ¯/åº“ | ç‰ˆæœ¬ | ç”¨é€” |
|---------|------|------|
| **Vue** | 3.2.37 | æ¸è¿›å¼ JavaScript æ¡†æ¶ |
| **TypeScript** | 4.6.4 | ç±»å‹å®‰å…¨ |
| **Naive UI** | 2.38.2 | Vue 3 ç»„ä»¶åº“ |
| **Pinia** | 2.1.7 | çŠ¶æ€ç®¡ç†ï¼ˆVuex ç»§ä»»è€…ï¼‰ |
| **Vue Router** | 4.3.3 | è·¯ç”±ç®¡ç† |
| **Axios** | 1.7.2 | HTTP å®¢æˆ·ç«¯ |
| **Vite** | 3.0.7 | å‰ç«¯æ„å»ºå·¥å…· |
| **Vue i18n** | 11.1.3 | å›½é™…åŒ–ï¼ˆä¸­/è‹±ï¼‰ |
| **Video.js / flv.js** | 8.22.0 / 1.6.2 | è§†é¢‘æ’­æ”¾å™¨ |

**å‰ç«¯ä¾èµ–è¯¦æƒ…**ï¼š

```json
{
  "dependencies": {
    "vue": "^3.2.37",
    "naive-ui": "^2.38.2",
    "pinia": "^2.1.7",
    "vue-router": "^4.3.3",
    "axios": "^1.7.2",
    "vue-i18n": "^11.1.3",
    "video.js": "^8.22.0",
    "flv.js": "^1.6.2"
  },
  "devDependencies": {
    "vite": "^3.0.7",
    "vue-tsc": "^1.8.27",
    "typescript": "^4.6.4",
    "@vitejs/plugin-vue": "^3.0.3",
    "tailwindcss": "^3.4.4",
    "sass": "^1.77.6"
  }
}
```

### 2.3 è·¨å¹³å°æ”¯æŒ

| å¹³å° | æ¶æ„ | ç³»ç»Ÿé›†æˆæ–¹å¼ |
|------|------|--------------|
| **Windows** | amd64 | æ³¨å†Œè¡¨ä»£ç†è®¾ç½® + è¯ä¹¦å­˜å‚¨ |
| **macOS** | amd64/arm64 | scutil ç½‘ç»œé…ç½® + Keychain |
| **Linux** | amd64 | gsettings/ç¯å¢ƒå˜é‡ + ä¿¡ä»»å­˜å‚¨ |

---

## ä¸‰ã€æ•´ä½“æ¶æ„è®¾è®¡

### 3.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·æ“ä½œå±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  èµ„æºåˆ—è¡¨    â”‚  â”‚  ä¸‹è½½ç®¡ç†    â”‚  â”‚  é…ç½®è®¾ç½®    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–²
                              â”‚ Wails IPC + HTTP/WebSocket
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Go åç«¯æ ¸å¿ƒå±‚                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ HTTP Server  â”‚  â”‚ Proxy Server â”‚  â”‚ Plugin Systemâ”‚          â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚          â”‚
â”‚  â”‚ - API å¤„ç†   â”‚  â”‚ - æµé‡æ‹¦æˆª   â”‚  â”‚ - åŸŸåè·¯ç”±   â”‚          â”‚
â”‚  â”‚ - äº‹ä»¶å‘é€   â”‚  â”‚ - MITM è§£å¯†  â”‚  â”‚ - èµ„æºæ£€æµ‹   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Resource Mgr â”‚  â”‚ Downloader   â”‚  â”‚ Config Mgr   â”‚          â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚          â”‚
â”‚  â”‚ - å»é‡ç®¡ç†   â”‚  â”‚ - å¤šçº¿ç¨‹ä¸‹è½½ â”‚  â”‚ - é…ç½®æŒä¹…åŒ– â”‚          â”‚
â”‚  â”‚ - ä¸‹è½½ç¼–æ’   â”‚  â”‚ - æ–­ç‚¹ç»­ä¼    â”‚  â”‚ - çƒ­æ›´æ–°     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Rule Engine  â”‚  â”‚ System Proxy â”‚  â”‚ Logger       â”‚          â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚          â”‚
â”‚  â”‚ - åŸŸååŒ¹é…   â”‚  â”‚ - å¹³å°é€‚é…   â”‚  â”‚ - ç»“æ„åŒ–æ—¥å¿— â”‚          â”‚
â”‚  â”‚ - MITM å†³ç­–  â”‚  â”‚ - è¯ä¹¦å®‰è£…   â”‚  â”‚ - æ–‡ä»¶è½®è½¬   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–²
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¤–éƒ¨ç³»ç»Ÿå±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  æµè§ˆå™¨      â”‚  â”‚  æ“ä½œç³»ç»Ÿ    â”‚  â”‚  ç›®æ ‡æœåŠ¡å™¨  â”‚          â”‚
â”‚  â”‚  (å®¢æˆ·ç«¯)    â”‚  â”‚  (ä»£ç†/è¯ä¹¦) â”‚  â”‚  (èµ„æºæº)    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ¨¡å—ä¾èµ–å…³ç³»

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   main.go   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚  app.go     â”‚ â—„â”€â”€ å•ä¾‹å…¥å£
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚  proxy.go    â”‚  â”‚   http.go       â”‚  â”‚ config.go â”‚
â”‚              â”‚  â”‚                 â”‚  â”‚           â”‚
â”‚ Proxy Server â”‚  â”‚ HTTP API Server â”‚  â”‚ é…ç½®ç®¡ç†  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚                  â”‚
       â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
       â”‚         â”‚                 â”‚         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚ plugins/    â”‚  â””â”€â–ºâ”‚resource.goâ”‚â—„â”€â”€â”˜â”€â”€â–ºâ”‚ rule.go   â”‚
â”‚             â”‚     â”‚          â”‚        â”‚           â”‚
â”‚ QqPlugin    â”‚     â”‚ Downloader        â”‚ RuleSet   â”‚
â”‚ DefaultPluginâ”‚   â”‚ Media Detection    â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                    â”‚downloader â”‚
                    â”‚   .go     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 æ ¸å¿ƒè®¾è®¡æ¨¡å¼

#### (1) å•ä¾‹æ¨¡å¼ (Singleton)
æ‰€æœ‰æ ¸å¿ƒå­ç³»ç»Ÿéƒ½ä½¿ç”¨å…¨å±€å•ä¾‹ï¼Œç¡®ä¿å…¨å±€å”¯ä¸€æ€§ï¼š

```go
var (
    appOnce        *App           // åº”ç”¨å®ä¾‹
    globalConfig   *Config        // é…ç½®
    globalLogger   *Logger        // æ—¥å¿—
    resourceOnce   *Resource      // èµ„æºç®¡ç†
    proxyOnce      *Proxy         // ä»£ç†
    httpServerOnce *HttpServer    // HTTP æœåŠ¡
    ruleOnce       *RuleSet       // è§„åˆ™å¼•æ“
)
```

**ä¼˜åŠ¿**ï¼š
- å…¨å±€è®¿é—®ç‚¹ï¼Œç®€åŒ–æ¨¡å—é—´é€šä¿¡
- å»¶è¿Ÿåˆå§‹åŒ–ï¼ŒèŠ‚çœèµ„æº
- çº¿ç¨‹å®‰å…¨ï¼ˆé€šè¿‡ init å‡½æ•°ä¿è¯ï¼‰

#### (2) Bridge æ¨¡å¼
æ’ä»¶ç³»ç»Ÿä½¿ç”¨ Bridge æ¨¡å¼è§£è€¦æ’ä»¶ä¸æ ¸å¿ƒä»£ç ï¼š

```go
type Bridge struct {
    GetVersion    func() string
    GetResType    func(key string) (bool, bool)
    TypeSuffix    func(mime string) (string, string)
    MediaIsMarked func(key string) bool
    MarkMedia     func(key string)
    GetConfig     func(key string) interface{}
    Send          func(t string, data interface{})
}
```

**ä¼˜åŠ¿**ï¼š
- é¿å…å¾ªç¯ä¾èµ–
- æ’ä»¶åªä¾èµ–æ¥å£ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
- æ˜“äºæµ‹è¯•å’Œæ›¿æ¢

#### (3) ç­–ç•¥æ¨¡å¼ (Strategy)
ä¸åŒåŸŸåä½¿ç”¨ä¸åŒçš„æ’ä»¶å¤„ç†ç­–ç•¥ï¼š

```go
type Plugin interface {
    Domains() []string
    OnRequest(*http.Request, *goproxy.ProxyCtx) (*http.Request, *http.Response)
    OnResponse(*http.Response, *goproxy.ProxyCtx) *http.Response
}
```

#### (4) å·¥å‚æ¨¡å¼ (Factory)
æ’ä»¶æ³¨å†Œè¡¨æ ¹æ®åŸŸååŠ¨æ€é€‰æ‹©æ’ä»¶ï¼š

```go
var pluginRegistry = make(map[string]shared.Plugin)

func (p *Proxy) matchPlugin(host string) shared.Plugin {
    domain := shared.GetTopLevelDomain(host)
    if plugin, ok := pluginRegistry[domain]; ok {
        return plugin
    }
    return nil
}
```

---

## å››ã€æ ¸å¿ƒæ¨¡å—æ·±åº¦è§£æ

### 4.1 ä»£ç†æœåŠ¡å™¨ (core/proxy.go)

#### åŠŸèƒ½èŒè´£
- HTTP/HTTPS æµé‡æ‹¦æˆªä¸è½¬å‘
- MITMï¼ˆä¸­é—´äººï¼‰è§£å¯† HTTPS æµé‡
- æ ¹æ®åŸŸåè·¯ç”±è¯·æ±‚åˆ°å¯¹åº”æ’ä»¶
- ç®¡ç†ä¸Šæ¸¸ä»£ç†é…ç½®

#### å…³é”®ä»£ç ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶:è¡Œå· | è¯´æ˜ |
|------|-----------|------|
| ä»£ç†å¯åŠ¨ | proxy.go:72-93 | åˆå§‹åŒ– goproxyï¼Œè®¾ç½® CA è¯ä¹¦ |
| CA è¯ä¹¦è®¾ç½® | proxy.go:95-109 | é…ç½® MITM è¯ä¹¦ |
| Transport é…ç½® | proxy.go:111-134 | ç½‘ç»œä¼ è¾“å±‚é…ç½®ï¼ˆè¶…æ—¶ã€ä¸Šæ¸¸ä»£ç†ï¼‰ |
| åŸŸååŒ¹é… | proxy.go:136-142 | æ’ä»¶è·¯ç”± |
| è¯·æ±‚å¤„ç† | proxy.go:144-157 | OnRequest å¤„ç†å™¨ |
| å“åº”å¤„ç† | proxy.go:159-173 | OnResponse å¤„ç†å™¨ |

#### å®ç°åŸç†è¯¦è§£

**(1) ä»£ç†åˆå§‹åŒ– (Startup)**

```go
// proxy.go:72-93
func (p *Proxy) Startup() {
    // 1. è®¾ç½® CA è¯ä¹¦
    err := p.setCa()
    if err != nil {
        DialogErr("Failed to start proxy serviceï¼š" + err.Error())
        return
    }

    // 2. åˆ›å»º goproxy å®ä¾‹
    p.Proxy = goproxy.NewProxyHttpServer()
    p.setTransport()

    // 3. é…ç½® HTTPS CONNECT å¤„ç†
    p.Proxy.OnRequest().HandleConnectFunc(func(host string, ctx *goproxy.ProxyCtx) (*goproxy.ConnectAction, string) {
        if ruleOnce.shouldMitm(host) {  // æ ¹æ®è§„åˆ™å†³å®šæ˜¯å¦ MITM
            return goproxy.MitmConnect, host
        }
        return goproxy.OkConnect, host  // é€ä¼ 
    })

    // 4. æ³¨å†Œè¯·æ±‚/å“åº”å¤„ç†å™¨
    p.Proxy.OnRequest().DoFunc(p.httpRequestEvent)
    p.Proxy.OnResponse().DoFunc(p.httpResponseEvent)
}
```

**æµç¨‹å›¾**ï¼š

```
ä»£ç†å¯åŠ¨
    â”‚
    â”œâ”€â–º è®¾ç½® CA è¯ä¹¦
    â”‚   â””â”€â–º ä» app.Once.PublicCrt åŠ è½½å†…åµŒè¯ä¹¦
    â”‚   â””â”€â–º é…ç½® goproxy.GoproxyCa
    â”‚
    â”œâ”€â–º åˆ›å»º ProxyHttpServer
    â”‚
    â”œâ”€â–º é…ç½® Transport
    â”‚   â”œâ”€â–º è®¾ç½®è¶…æ—¶ï¼ˆ60s è¿æ¥ï¼Œ30s ç©ºé—²ï¼‰
    â”‚   â””â”€â–º å¦‚æœæœ‰ä¸Šæ¸¸ä»£ç†ï¼Œé…ç½® ProxyURL
    â”‚
    â”œâ”€â–º æ³¨å†Œ CONNECT å¤„ç†å™¨
    â”‚   â””â”€â–º è§„åˆ™å¼•æ“åˆ¤æ–­ shouldMitm(host)
    â”‚       â”œâ”€â–º true â†’ MitmConnectï¼ˆè§£å¯†ï¼‰
    â”‚       â””â”€â–º false â†’ OkConnectï¼ˆé€ä¼ ï¼‰
    â”‚
    â””â”€â–º æ³¨å†Œè¯·æ±‚/å“åº”å¤„ç†å™¨
```

**(2) MITM å®ç°ç»†èŠ‚**

CA è¯ä¹¦ç»“æ„ï¼ˆapp.go:58-110ï¼‰ï¼š

```
-----BEGIN CERTIFICATE-----
MIIDwzCCAqugAwIBAgIUFAnC6268dp/z1DR9E1UepiWgWzkwDQYJKoZIhvcNAQEL
BQAwcDELMAkGA1UEBhMCQ04xEjAQBgNVBAgMCUNob25ncWluZzESMBAGA1UEBwwJ
Q2hvbmdxaW5nMQ4wDAYDVQQKDAVnb3dhczEWMBQGA1UECwwNSVQgRGVwYXJ0bWVu
dDERMA8GA1UEAwwIZ293YXMuY24wIBcNMjQwMjE4MDIwOTI2WhgPMjEyNDAxMjUw
MjA5MjZaMHAxCzAJBgNVBAYTAkNOMRIwEAYDVQQIDAlDaG9uZ3FpbmcxEjAQBgNV
BAcMCUNob25ncWluZzEOMAwGA1UECgwFZ293YXMxFjAUBgNVBAsMDUlQgRGVwYXJ0
bWVudDETAPBgNVBAMMCGdvd2FzLmNu...
-----END CERTIFICATE-----
```

**è¯ä¹¦ä¿¡æ¯**ï¼š
- **é¢å‘è€…**: gowas.cn (IT Department)
- **æœ‰æ•ˆæœŸ**: 2024-02-18 è‡³ 2124-01-25ï¼ˆ100 å¹´ï¼‰
- **ç”¨é€”**: HTTPS MITM è§£å¯†
- **å®‰è£…ä½ç½®**:
  - Windows: ç³»ç»Ÿè¯ä¹¦å­˜å‚¨ â†’ "å—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„"
  - macOS: Keychain Access â†’ System â†’ Certificates
  - Linux: /usr/local/share/ca-certificates/

**(3) æ’ä»¶è·¯ç”±æœºåˆ¶**

```go
// proxy.go:136-142
func (p *Proxy) matchPlugin(host string) shared.Plugin {
    domain := shared.GetTopLevelDomain(host)  // æå–é¡¶çº§åŸŸå
    if plugin, ok := pluginRegistry[domain]; ok {
        return plugin
    }
    return nil
}
```

**åŸŸåæå–é€»è¾‘** (shared/utils.go)ï¼š

```go
// ç¤ºä¾‹ï¼š
// "video.qq.com"      â†’ "qq.com"
// "api.weixin.qq.com" â†’ "qq.com"
// "www.douyin.com"    â†’ "douyin.com"
```

**æ’ä»¶æ³¨å†Œè¡¨**ï¼š

```go
// proxy.go:26-62
func init() {
    ps := []shared.Plugin{
        &plugins.QqPlugin{},      // å¤„ç† qq.com
        &plugins.DefaultPlugin{},  // å¤„ç†æ‰€æœ‰å…¶ä»–åŸŸå
    }

    bridge := &shared.Bridge{...}

    for _, p := range ps {
        p.SetBridge(bridge)
        for _, domain := range p.Domains() {
            pluginRegistry[domain] = p
        }
    }
}
```

**(4) è¯·æ±‚/å“åº”å¤„ç†æµç¨‹**

```go
// proxy.go:144-157 (è¯·æ±‚å¤„ç†)
func (p *Proxy) httpRequestEvent(r *http.Request, ctx *goproxy.ProxyCtx) (*http.Request, *http.Response) {
    plugin := p.matchPlugin(r.Host)
    if plugin != nil {
        newReq, newResp := plugin.OnRequest(r, ctx)
        if newResp != nil {
            return newReq, newResp  // æ’ä»¶è¿”å›è‡ªå®šä¹‰å“åº”
        }
        if newReq != nil {
            return newReq, nil  // æ’ä»¶ä¿®æ”¹äº†è¯·æ±‚
        }
    }
    return pluginRegistry["default"].OnRequest(r, ctx)  // é»˜è®¤å¤„ç†
}

// proxy.go:159-173 (å“åº”å¤„ç†)
func (p *Proxy) httpResponseEvent(resp *http.Response, ctx *goproxy.ProxyCtx) *http.Response {
    if resp == nil || resp.Request == nil {
        return resp
    }

    plugin := p.matchPlugin(resp.Request.Host)
    if plugin != nil {
        newResp := plugin.OnResponse(resp, ctx)
        if newResp != nil {
            return newResp
        }
    }

    return pluginRegistry["default"].OnResponse(resp, ctx)
}
```

**å¤„ç†æµç¨‹**ï¼š

```
HTTP Request â†’ Proxy Server
                    â”‚
                    â”œâ”€â–º æå– Host
                    â”‚
                    â”œâ”€â–º åŒ¹é…æ’ä»¶
                    â”‚   â”‚
                    â”‚   â”œâ”€â–º æ‰¾åˆ°æ’ä»¶ â†’ Plugin.OnRequest()
                    â”‚   â”‚               â”‚
                    â”‚   â”‚               â”œâ”€â–º è¿”å› newResp â†’ ç›´æ¥è¿”å›å“åº”
                    â”‚   â”‚               â”œâ”€â–º è¿”å› newReq â†’ ä½¿ç”¨ä¿®æ”¹åçš„è¯·æ±‚
                    â”‚   â”‚               â””â”€â–º è¿”å› nil â†’ ç»§ç»­è½¬å‘
                    â”‚   â”‚
                    â”‚   â””â”€â–º æœªæ‰¾åˆ° â†’ DefaultPlugin.OnRequest()
                    â”‚
                    â””â”€â–º è½¬å‘è¯·æ±‚åˆ°ç›®æ ‡æœåŠ¡å™¨
                                â”‚
                                â–¼
HTTP Response â† ç›®æ ‡æœåŠ¡å™¨
                    â”‚
                    â”œâ”€â–º åŒ¹é…æ’ä»¶
                    â”‚   â”‚
                    â”‚   â”œâ”€â–º æ‰¾åˆ°æ’ä»¶ â†’ Plugin.OnResponse()
                    â”‚   â”‚               â”‚
                    â”‚   â”‚               â”œâ”€â–º æ£€æµ‹èµ„æº
                    â”‚   â”‚               â”œâ”€â–º æå– MediaInfo
                    â”‚   â”‚               â”œâ”€â–º å‘é€äº‹ä»¶
                    â”‚   â”‚               â””â”€â–º è¿”å›å“åº”
                    â”‚   â”‚
                    â”‚   â””â”€â–º æœªæ‰¾åˆ° â†’ DefaultPlugin.OnResponse()
                    â”‚
                    â””â”€â–º è¿”å›ç»™å®¢æˆ·ç«¯
```

---

### 4.2 æ’ä»¶ç³»ç»Ÿ (core/plugins/ + core/shared/plugin.go)

#### åŠŸèƒ½èŒè´£
- åŸŸåç‰¹å®šçš„èµ„æºå¤„ç†é€»è¾‘
- è¯·æ±‚/å“åº”æ‹¦æˆªä¸ä¿®æ”¹
- èµ„æºæ£€æµ‹ä¸æå–
- ä¸æ ¸å¿ƒç³»ç»Ÿäº¤äº’ï¼ˆé€šè¿‡ Bridgeï¼‰

#### æ’ä»¶æ¥å£å®šä¹‰

```go
// shared/plugin.go:18-23
type Plugin interface {
    SetBridge(*Bridge)                                            // æ³¨å…¥ä¾èµ–
    Domains() []string                                           // å£°æ˜å¤„ç†çš„åŸŸå
    OnRequest(*http.Request, *goproxy.ProxyCtx) (*http.Request, *http.Response)
    OnResponse(*http.Response, *goproxy.ProxyCtx) *http.Response
}
```

#### Bridge è®¾è®¡

**ç›®çš„**ï¼šè§£è€¦æ’ä»¶ä¸æ ¸å¿ƒä»£ç ï¼Œé¿å…å¾ªç¯ä¾èµ–

```go
// shared/plugin.go:8-16
type Bridge struct {
    GetVersion    func() string                                 // è·å–åº”ç”¨ç‰ˆæœ¬
    GetResType    func(key string) (bool, bool)                 // æ£€æŸ¥èµ„æºç±»å‹æ˜¯å¦å¯ç”¨
    TypeSuffix    func(mime string) (string, string)            // è·å– MIME ç±»å‹å¯¹åº”çš„åˆ†ç±»å’Œåç¼€
    MediaIsMarked func(key string) bool                         // æ£€æŸ¥èµ„æºæ˜¯å¦å·²æ ‡è®°
    MarkMedia     func(key string)                              // æ ‡è®°èµ„æºä¸ºå·²å¤„ç†
    GetConfig     func(key string) interface{}                  // è·å–é…ç½®é¡¹
    Send          func(t string, data interface{})              // å‘é€äº‹ä»¶åˆ°å‰ç«¯
}
```

**Bridge åˆå§‹åŒ–** (proxy.go:32-54)ï¼š

```go
bridge := &shared.Bridge{
    GetVersion: func() string {
        return appOnce.Version
    },
    GetResType: func(key string) (bool, bool) {
        return resourceOnce.getResType(key)
    },
    TypeSuffix: func(mime string) (string, string) {
        return globalConfig.typeSuffix(mime)
    },
    MediaIsMarked: func(key string) bool {
        return resourceOnce.mediaIsMarked(key)
    },
    MarkMedia: func(key string) {
        resourceOnce.markMedia(key)
    },
    GetConfig: func(key string) interface{} {
        return globalConfig.getConfig(key)
    },
    Send: func(t string, data interface{}) {
        httpServerOnce.send(t, data)
    },
}
```

#### ç°æœ‰æ’ä»¶è¯¦è§£

##### (1) DefaultPlugin - é€šç”¨èµ„æºæ£€æµ‹æ’ä»¶

**å¤„ç†åŸŸå**: æ‰€æœ‰æœªåŒ¹é…çš„åŸŸåï¼ˆfallbackï¼‰

**æ–‡ä»¶ä½ç½®**: `core/plugins/plugin.default.go`

**æ ¸å¿ƒé€»è¾‘**ï¼š

```go
func (p *DefaultPlugin) OnResponse(resp *http.Response, ctx *goproxy.ProxyCtx) *http.Response {
    if resp == nil || resp.Request == nil {
        return resp
    }

    // 1. æ£€æŸ¥å“åº”ç 
    if resp.StatusCode != 200 && resp.StatusCode != 206 {
        return resp
    }

    // 2. è·å– Content-Type
    contentType := resp.Header.Get("Content-Type")

    // 3. æŸ¥è¯¢ MIME æ˜ å°„
    classify, suffix := p.bridge.TypeSuffix(contentType)

    // 4. å¦‚æœä¸æ˜¯ç›®æ ‡èµ„æºç±»å‹ï¼Œç›´æ¥è¿”å›
    if classify == "" {
        return resp
    }

    // 5. æ£€æŸ¥èµ„æºç±»å‹æ˜¯å¦å¯ç”¨
    isAll, _ := p.bridge.GetResType("all")
    isType, _ := p.bridge.GetResType(classify)
    if !isAll && !isType {
        return resp
    }

    // 6. æå– URL
    url := resp.Request.URL.String()

    // 7. ç”Ÿæˆ MD5 ç­¾å
    urlSign := shared.Md5(url)

    // 8. å»é‡æ£€æŸ¥
    if p.bridge.MediaIsMarked(urlSign) {
        return resp
    }

    // 9. åˆ›å»º MediaInfo
    mediaInfo := shared.MediaInfo{
        Id:          generateId(),
        Url:         url,
        UrlSign:     urlSign,
        Domain:      shared.GetTopLevelDomain(url),
        Classify:    classify,
        Suffix:      suffix,
        Status:      shared.DownloadStatusReady,
        ContentType: contentType,
        OtherData:   map[string]string{},
    }

    // 10. æå–å…¶ä»–ä¿¡æ¯ï¼ˆæ–‡ä»¶å¤§å°ã€Headers ç­‰ï¼‰
    if resp.ContentLength > 0 {
        mediaInfo.Size = float64(resp.ContentLength)
    }

    headersMap := make(map[string][]string)
    for key, values := range resp.Header {
        headersMap[key] = values
    }
    if jsonData, err := json.Marshal(headersMap); err == nil {
        mediaInfo.OtherData["headers"] = string(jsonData)
    }

    // 11. æ ‡è®°ä¸ºå·²å¤„ç†
    p.bridge.MarkMedia(urlSign)

    // 12. å‘é€äº‹ä»¶åˆ°å‰ç«¯
    p.bridge.Send("newResources", mediaInfo)

    return resp
}
```

**å¤„ç†æµç¨‹å›¾**ï¼š

```
OnResponse(resp)
        â”‚
        â”œâ”€â–º æ£€æŸ¥å“åº”ç 
        â”‚   â””â”€â–º é 200/206 â†’ è¿”å›
        â”‚
        â”œâ”€â–º è·å– Content-Type
        â”‚
        â”œâ”€â–º æŸ¥è¯¢ MIME æ˜ å°„
        â”‚   â””â”€â–º æœªåŒ¹é… â†’ è¿”å›
        â”‚
        â”œâ”€â–º æ£€æŸ¥èµ„æºç±»å‹æ˜¯å¦å¯ç”¨
        â”‚   â””â”€â–º æœªå¯ç”¨ â†’ è¿”å›
        â”‚
        â”œâ”€â–º ç”Ÿæˆ URL MD5 ç­¾å
        â”‚
        â”œâ”€â–º å»é‡æ£€æŸ¥
        â”‚   â””â”€â–º å·²å¤„ç† â†’ è¿”å›
        â”‚
        â”œâ”€â–º åˆ›å»º MediaInfo
        â”‚   â”œâ”€â–º æå– URL
        â”‚   â”œâ”€â–º æå–æ–‡ä»¶å¤§å°
        â”‚   â”œâ”€â–º æå– Headers
        â”‚   â””â”€â–º æå–å…¶ä»–å…ƒæ•°æ®
        â”‚
        â”œâ”€â–º æ ‡è®°ä¸ºå·²å¤„ç†
        â”‚
        â”œâ”€â–º å‘é€ "newResources" äº‹ä»¶
        â”‚
        â””â”€â–º è¿”å›å“åº”
```

##### (2) QqPlugin - QQ/å¾®ä¿¡ä¸“ç”¨æ’ä»¶

**å¤„ç†åŸŸå**: `qq.com`

**æ–‡ä»¶ä½ç½®**: `core/plugins/plugin.qq.com.go`

**ç‰¹æ®ŠåŠŸèƒ½**ï¼š
1. **JavaScript æ³¨å…¥**ï¼šä¿®æ”¹å¾®ä¿¡é¡µé¢ JSï¼Œæ³¨å…¥èµ„æºæå–ä»£ç 
2. **è‡ªå®šä¹‰è¯·æ±‚å¤„ç†**ï¼šæ‹¦æˆª `/res-downloader/wechat` è¯·æ±‚
3. **è§£å¯†æ”¯æŒ**ï¼šå¤„ç†å¾®ä¿¡è§†é¢‘çš„åŠ å¯†èµ„æº

**å…³é”®ä»£ç ç‰‡æ®µ**ï¼š

```go
// plugin.qq.com.go:63-65
// æ³¨å…¥ä»£ç åˆ°å¾®ä¿¡é¡µé¢
if strings.HasSuffix(host, "channels.weixin.qq.com") &&
    (strings.Contains(Path, "/web/pages/feed") || strings.Contains(Path, "/web/pages/home")) {
    return p.replaceWxJsContent(resp, ".js\"", ".js?v="+p.v()+"\"")
}

// plugin.qq.com.go:75-112
// ä¿®æ”¹è™šæ‹Ÿ SVG å›¾æ ‡æ³¨å†Œè„šæœ¬ï¼Œæ³¨å…¥ media æå–ä»£ç 
if strings.Contains(Path, "web/web-finder/res/js/virtual_svg-icons-register.publish") {
    body, _ := io.ReadAll(resp.Body)
    bodyStr := string(body)

    // æ›¿æ¢ get media() æ–¹æ³•
    newBody := qqMediaRegex.ReplaceAllString(bodyStr, `
        get media(){
            if(this.objectDesc){
                fetch("https://wxapp.tc.qq.com/res-downloader/wechat?type=1", {
                    method: "POST",
                    mode: "no-cors",
                    body: JSON.stringify(this.objectDesc),
                });
            }
        `)

    // æ›¿æ¢è¯„è®ºè·å–æ–¹æ³•
    newBody = qqCommentRegex.ReplaceAllString(newBody, `
        async finderGetCommentDetail($1) {
            var res = await$2;
            if (res?.data?.object?.objectDesc) {
                fetch("https://wxapp.tc.qq.com/res-downloader/wechat?type=2", {
                    method: "POST",
                    mode: "no-cors",
                    body: JSON.stringify(res.data.object.objectDesc),
                });
            }
            return res;
        }async
    `)

    // è¿”å›ä¿®æ”¹åçš„å“åº”
    resp.Body = io.NopCloser(bytes.NewBuffer([]byte(newBody)))
    resp.ContentLength = int64(len(newBody))
    return resp
}
```

**JavaScript æ³¨å…¥åŸç†**ï¼š

```
åŸå§‹å¾®ä¿¡é¡µé¢:
    åŠ è½½ virtual_svg-icons-register.publish.js
        â”‚
        â”œâ”€â–º å®šä¹‰ get media() { ... }
        â””â”€â–º å®šä¹‰ finderGetCommentDetail() { ... }

â†“ æ’ä»¶æ‹¦æˆªå¹¶æ›¿æ¢ JS æ–‡ä»¶

ä¿®æ”¹åçš„ JS:
    get media(){
        if(this.objectDesc){
            // å‘é€èµ„æºä¿¡æ¯åˆ°ä»£ç†æœåŠ¡å™¨
            fetch("https://wxapp.tc.qq.com/res-downloader/wechat?type=1", {
                method: "POST",
                body: JSON.stringify(this.objectDesc),  // åŒ…å«è§†é¢‘ URLã€token ç­‰
            });
        }
    }

    async finderGetCommentDetail($1) {
        var res = await$2;
        if (res?.data?.object?.objectDesc) {
            // è¯„è®ºä¸­çš„è§†é¢‘ä¹Ÿå‘é€
            fetch("https://wxapp.tc.qq.com/res-downloader/wechat?type=2", {...});
        }
        return res;
    }

â†“ æ’ä»¶æ¥æ”¶ POST è¯·æ±‚

plugin.qq.com.go: handleWechatRequest()
    â”œâ”€â–º è§£æè¯·æ±‚ body
    â”œâ”€â–º æå– media æ•°ç»„
    â”œâ”€â–º åˆ›å»º MediaInfo
    â””â”€â–º å‘é€åˆ°å‰ç«¯
```

---

### 4.3 ä¸‹è½½å¼•æ“ (core/downloader.go)

#### åŠŸèƒ½èŒè´£
- å¤šçº¿ç¨‹å¹¶å‘ä¸‹è½½
- åŸºäº HTTP Range çš„åˆ†ç‰‡ä¸‹è½½
- æ–­ç‚¹ç»­ä¼ æ”¯æŒ
- è‡ªåŠ¨é‡è¯•ä¸é™çº§
- å®æ—¶è¿›åº¦æŠ¥å‘Š

#### æ ¸å¿ƒæ•°æ®ç»“æ„

```go
// downloader.go:30-37
type DownloadTask struct {
    taskID         int       // ä»»åŠ¡ ID
    rangeStart     int64     // åˆ†ç‰‡èµ·å§‹ä½ç½®
    rangeEnd       int64     // åˆ†ç‰‡ç»“æŸä½ç½®
    downloadedSize int64     // å·²ä¸‹è½½å¤§å°
    isCompleted    bool      // æ˜¯å¦å®Œæˆ
    err            error     // é”™è¯¯ä¿¡æ¯
}

// downloader.go:39-54
type FileDownloader struct {
    Url              string                  // ä¸‹è½½ URL
    Referer          string                  // Referer
    ProxyUrl         *url.URL                // ä»£ç† URL
    FileName         string                  // ä¿å­˜æ–‡ä»¶å
    File             *os.File                // æ–‡ä»¶å¥æŸ„
    totalTasks       int                     // æ€»ä»»åŠ¡æ•°
    TotalSize        int64                   // æ–‡ä»¶æ€»å¤§å°
    IsMultiPart      bool                    // æ˜¯å¦å¤šçº¿ç¨‹
    RetryOnError     bool                    // æ˜¯å¦æ­£åœ¨é‡è¯•
    Headers          map[string]string       // è‡ªå®šä¹‰ Headers
    DownloadTaskList []*DownloadTask         // ä¸‹è½½ä»»åŠ¡åˆ—è¡¨
    progressCallback ProgressCallback        // è¿›åº¦å›è°ƒ
    ctx              context.Context         // ä¸Šä¸‹æ–‡ï¼ˆç”¨äºå–æ¶ˆï¼‰
    cancelFunc       context.CancelFunc      // å–æ¶ˆå‡½æ•°
}
```

#### ä¸‹è½½æµç¨‹è¯¦è§£

**ä¸»æµç¨‹** (downloader.go:417-430)ï¼š

```go
func (fd *FileDownloader) Start() error {
    // 1. åˆå§‹åŒ–
    if err := fd.init(); err != nil {
        return err
    }

    // 2. åˆ›å»ºä¸‹è½½ä»»åŠ¡
    fd.createDownloadTasks()

    // 3. å¼€å§‹ä¸‹è½½
    err := fd.startDownload()

    // 4. å…³é—­æ–‡ä»¶
    if fd.File != nil {
        fd.File.Close()
    }

    return err
}
```

**æµç¨‹å›¾**ï¼š

```
Start()
    â”‚
    â”œâ”€â–º init()
    â”‚   â”œâ”€â–º è§£æ URLï¼Œè®¾ç½® Referer
    â”‚   â”œâ”€â–º å‘é€ HEAD è¯·æ±‚è·å–æ–‡ä»¶å¤§å°
    â”‚   â”œâ”€â–º æ£€æŸ¥æ˜¯å¦æ”¯æŒ Range
    â”‚   â”œâ”€â–º åˆ›å»ºå¹¶é¢„åˆ†é…æ–‡ä»¶
    â”‚   â””â”€â–º è¿”å›
    â”‚
    â”œâ”€â–º createDownloadTasks()
    â”‚   â”œâ”€â–º è®¡ç®—åˆ†ç‰‡æ•°é‡
    â”‚   â”œâ”€â–º åˆ†é… Rangeï¼ˆæ¯ç‰‡è‡³å°‘ 1MBï¼‰
    â”‚   â””â”€â–º åˆ›å»º DownloadTask åˆ—è¡¨
    â”‚
    â”œâ”€â–º startDownload()
    â”‚   â”œâ”€â–º å¯åŠ¨ N ä¸ª goroutines
    â”‚   â”‚   â””â”€â–º æ¯ä¸ªä¸‹è½½ä¸€ä¸ªåˆ†ç‰‡
    â”‚   â”‚       â”œâ”€â–º å‘é€ Range è¯·æ±‚
    â”‚   â”‚       â”œâ”€â–º ä¸‹è½½åˆ†ç‰‡æ•°æ®
    â”‚   â”‚       â”œâ”€â–º å†™å…¥æ–‡ä»¶å¯¹åº”ä½ç½®
    â”‚   â”‚       â””â”€â–º å‘é€è¿›åº¦åˆ° channel
    â”‚   â”‚
    â”‚   â”œâ”€â–º èšåˆè¿›åº¦å¹¶å›è°ƒ
    â”‚   â”œâ”€â–º æ”¶é›†é”™è¯¯
    â”‚   â”‚   â””â”€â–º å¦‚æœæœ‰é”™è¯¯
    â”‚   â”‚       â”œâ”€â–º å¦‚æœæ˜¯å¤šçº¿ç¨‹ä¸”æœªé‡è¯•è¿‡
    â”‚   â”‚       â”‚   â””â”€â–º é™çº§ä¸ºå•çº¿ç¨‹ï¼Œé‡è¯•
    â”‚   â”‚       â””â”€â–º å¦åˆ™è¿”å›é”™è¯¯
    â”‚   â”‚
    â”‚   â””â”€â–º éªŒè¯ä¸‹è½½å®Œæ•´æ€§
    â”‚
    â””â”€â–º å…³é—­æ–‡ä»¶
```

#### å…³é”®å®ç°ç»†èŠ‚

**(1) åˆå§‹åŒ– - è·å–æ–‡ä»¶ä¿¡æ¯**

```go
// downloader.go:126-199
func (fd *FileDownloader) init() error {
    // 1. è®¾ç½® Referer
    parsedURL, err := url.Parse(fd.Url)
    if err != nil {
        return fmt.Errorf("parse URL failed: %w", err)
    }
    fd.Referer = parsedURL.Scheme + "://" + parsedURL.Host + "/"

    // 2. é…ç½®ä»£ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if globalConfig.DownloadProxy && globalConfig.UpstreamProxy != "" {
        proxyURL, err := url.Parse(globalConfig.UpstreamProxy)
        if err == nil {
            fd.ProxyUrl = proxyURL
        }
    }

    // 3. å‘é€ HEAD è¯·æ±‚
    request, err := http.NewRequest("HEAD", fd.Url, nil)
    if err != nil {
        return fmt.Errorf("create HEAD request failed: %w", err)
    }

    // è®¾ç½® Headers
    fd.setHeaders(request)

    // é‡è¯• 3 æ¬¡
    var resp *http.Response
    for retries := 0; retries < MaxRetries; retries++ {
        resp, err = fd.buildClient().Do(request)
        if err == nil {
            break
        }
        if retries < MaxRetries-1 {
            time.Sleep(RetryDelay)
        }
    }

    if err != nil {
        return fmt.Errorf("HEAD request failed after %d retries: %w", MaxRetries, err)
    }
    defer resp.Body.Close()

    // 4. æå–æ–‡ä»¶ä¿¡æ¯
    fd.TotalSize = resp.ContentLength
    if resp.Header.Get("Accept-Ranges") == "bytes" && fd.TotalSize > MinPartSize {
        fd.IsMultiPart = true  // æ”¯æŒå¤šçº¿ç¨‹
    }

    // 5. åˆ›å»ºæ–‡ä»¶å¹¶é¢„åˆ†é…ç©ºé—´
    dir := filepath.Dir(fd.FileName)
    os.MkdirAll(dir, os.ModePerm)

    fd.FileName = shared.GetUniqueFileName(fd.FileName)  // é¿å…é‡å
    fd.File, err = os.OpenFile(fd.FileName, os.O_RDWR|os.O_CREATE, 0644)
    if err != nil {
        return fmt.Errorf("file open failed: %w", err)
    }

    if fd.TotalSize > 0 {
        fd.File.Truncate(fd.TotalSize)  // é¢„åˆ†é…ç©ºé—´
    }

    return nil
}
```

**(2) åˆ›å»ºä¸‹è½½ä»»åŠ¡**

```go
// downloader.go:201-239
func (fd *FileDownloader) createDownloadTasks() {
    if fd.IsMultiPart {
        // å¤šçº¿ç¨‹æ¨¡å¼
        if fd.totalTasks <= 0 {
            fd.totalTasks = 4
        }

        // è®¡ç®—æ¯ä¸ªåˆ†ç‰‡å¤§å°
        eachSize := fd.TotalSize / int64(fd.totalTasks)

        // ç¡®ä¿æ¯ç‰‡è‡³å°‘ 1MB
        if eachSize < MinPartSize {
            fd.totalTasks = int(fd.TotalSize / MinPartSize)
            if fd.totalTasks < 1 {
                fd.totalTasks = 1
            }
            eachSize = fd.TotalSize / int64(fd.totalTasks)
        }

        // åˆ›å»ºåˆ†ç‰‡ä»»åŠ¡
        for i := 0; i < fd.totalTasks; i++ {
            start := eachSize * int64(i)
            end := eachSize*int64(i+1) - 1
            if i == fd.totalTasks-1 {
                end = fd.TotalSize - 1  // æœ€åä¸€ç‰‡åŒ…å«å‰©ä½™æ‰€æœ‰å­—èŠ‚
            }
            fd.DownloadTaskList = append(fd.DownloadTaskList, &DownloadTask{
                taskID:     i,
                rangeStart: start,
                rangeEnd:   end,
            })
        }
    } else {
        // å•çº¿ç¨‹æ¨¡å¼
        fd.totalTasks = 1
        rangeEnd := int64(-1)
        if fd.TotalSize > 0 {
            rangeEnd = fd.TotalSize - 1
        }
        fd.DownloadTaskList = append(fd.DownloadTaskList, &DownloadTask{
            taskID:     0,
            rangeStart: 0,
            rangeEnd:   rangeEnd,
        })
    }
}
```

**åˆ†ç‰‡ç¤ºä¾‹**ï¼š

```
æ–‡ä»¶å¤§å°: 100MB, å¹¶å‘æ•°: 4

åˆ†ç‰‡è®¡ç®—:
    eachSize = 100MB / 4 = 25MB

åˆ†ç‰‡ç»“æœ:
    Task 0: Range: 0-26214399      (0-25MB)
    Task 1: Range: 26214400-52428799 (25MB-50MB)
    Task 2: Range: 52428800-78643199 (50MB-75MB)
    Task 3: Range: 78643200-104857599 (75MB-100MB)
```

**(3) å¹¶å‘ä¸‹è½½ä¸è¿›åº¦èšåˆ**

```go
// downloader.go:241-301
func (fd *FileDownloader) startDownload() error {
    wg := &sync.WaitGroup{}
    progressChan := make(chan ProgressChan, len(fd.DownloadTaskList))
    errorChan := make(chan error, len(fd.DownloadTaskList))

    // å¯åŠ¨æ‰€æœ‰ä¸‹è½½ä»»åŠ¡
    for _, task := range fd.DownloadTaskList {
        wg.Add(1)
        go fd.startDownloadTask(wg, progressChan, errorChan, task)
    }

    // å¯åŠ¨è¿›åº¦èšåˆ goroutine
    go func() {
        taskProgress := make([]int64, len(fd.DownloadTaskList))
        totalDownloaded := int64(0)

        for progress := range progressChan {
            // æ›´æ–°ä»»åŠ¡è¿›åº¦
            taskProgress[progress.taskID] += progress.bytes
            totalDownloaded += progress.bytes

            // è®¡ç®—ä»»åŠ¡ç™¾åˆ†æ¯”
            taskPercentage := float64(0)
            if task := fd.DownloadTaskList[progress.taskID]; task != nil {
                taskSize := task.rangeEnd - task.rangeStart + 1
                if taskSize > 0 {
                    taskPercentage = float64(taskProgress[progress.taskID]) / float64(taskSize) * 100
                }
            }

            // å›è°ƒè¿›åº¦
            if fd.progressCallback != nil {
                fd.progressCallback(
                    float64(totalDownloaded),
                    float64(fd.TotalSize),
                    progress.taskID,
                    taskPercentage
                )
            }
        }
    }()

    // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    go func() {
        wg.Wait()
        close(progressChan)
        close(errorChan)
    }()

    // æ”¶é›†é”™è¯¯
    var errArr []error
    for err := range errorChan {
        errArr = append(errArr, err)
    }

    // é”™è¯¯å¤„ç†
    if len(errArr) > 0 {
        if !fd.RetryOnError && fd.IsMultiPart {
            // é™çº§ä¸ºå•çº¿ç¨‹
            fd.RetryOnError = true
            fd.DownloadTaskList = []*DownloadTask{}
            fd.totalTasks = 1
            fd.IsMultiPart = false
            fd.createDownloadTasks()
            return fd.startDownload()
        }
        return fmt.Errorf("download failed with %d errors: %v", len(errArr), errArr[0])
    }

    // éªŒè¯å®Œæ•´æ€§
    if err := fd.verifyDownload(); err != nil {
        return err
    }

    return nil
}
```

**è¿›åº¦æŠ¥å‘Šæœºåˆ¶**ï¼š

```
Goroutine 1 (Task 0)
    â”‚
    â””â”€â–º ä¸‹è½½ 32KB â†’ progressChan <- {taskID: 0, bytes: 32768}
         â”‚
         â–¼
Goroutine 2 (Task 1)
    â”‚
    â””â”€â–º ä¸‹è½½ 32KB â†’ progressChan <- {taskID: 1, bytes: 32768}
         â”‚
         â–¼
        ...
         â”‚
         â–¼
    Progress Aggregator (ä¸» goroutine)
        â”‚
        â”œâ”€â–º æ¥æ”¶è¿›åº¦
        â”œâ”€â–º æ›´æ–° taskProgress[taskID]
        â”œâ”€â–º ç´¯åŠ  totalDownloaded
        â”œâ”€â–º è®¡ç®—ä»»åŠ¡ç™¾åˆ†æ¯”
        â””â”€â–º å›è°ƒ progressCallback(
                totalDownloaded,
                TotalSize,
                taskID,
                taskPercentage
            )
                â”‚
                â–¼
            å‰ç«¯ UI æ›´æ–°
```

**(4) å•ä¸ªä»»åŠ¡ä¸‹è½½**

```go
// downloader.go:334-398
func (fd *FileDownloader) doDownloadTask(progressChan chan ProgressChan, task *DownloadTask) error {
    // 1. æ£€æŸ¥å–æ¶ˆ
    select {
    case <-fd.ctx.Done():
        return fmt.Errorf("download cancelled")
    default:
    }

    // 2. åˆ›å»ºè¯·æ±‚
    request, err := http.NewRequestWithContext(fd.ctx, "GET", fd.Url, nil)
    if err != nil {
        return fmt.Errorf("create request failed: %w", err)
    }
    fd.setHeaders(request)

    // 3. è®¾ç½® Range
    if fd.IsMultiPart {
        rangeStart := task.rangeStart + task.downloadedSize
        rangeHeader := fmt.Sprintf("bytes=%d-%d", rangeStart, task.rangeEnd)
        request.Header.Set("Range", rangeHeader)
    }

    // 4. å‘é€è¯·æ±‚
    client := fd.buildClient()
    resp, err := client.Do(request)
    if err != nil {
        return fmt.Errorf("send request failed: %w", err)
    }
    defer resp.Body.Close()

    // 5. æ£€æŸ¥å“åº”ç 
    if fd.IsMultiPart && resp.StatusCode != http.StatusPartialContent {
        return fmt.Errorf("server does not support range requests, status: %d", resp.StatusCode)
    } else if !fd.IsMultiPart && resp.StatusCode != http.StatusOK {
        return fmt.Errorf("unexpected status code: %d", resp.StatusCode)
    }

    // 6. ä¸‹è½½æ•°æ®
    buf := make([]byte, 32*1024)  // 32KB ç¼“å†²åŒº
    for {
        select {
        case <-fd.ctx.Done():
            return fmt.Errorf("download cancelled")
        default:
        }

        n, err := resp.Body.Read(buf)
        if n > 0 {
            // å†™å…¥æ–‡ä»¶å¯¹åº”ä½ç½®
            writeSize := int64(n)
            offset := task.rangeStart + task.downloadedSize
            _, writeErr := fd.File.WriteAt(buf[:writeSize], offset)
            if writeErr != nil {
                return fmt.Errorf("write file failed at offset %d: %w", offset, writeErr)
            }

            // æ›´æ–°è¿›åº¦
            task.downloadedSize += writeSize
            progressChan <- ProgressChan{taskID: task.taskID, bytes: writeSize}

            // æ£€æŸ¥æ˜¯å¦å®Œæˆ
            if fd.TotalSize > 0 && task.rangeStart+task.downloadedSize-1 >= task.rangeEnd {
                return nil
            }
        }

        if err != nil {
            if err == io.EOF {
                return nil
            }
            return fmt.Errorf("read response failed: %w", err)
        }
    }
}
```

**(5) æ™ºèƒ½é™çº§æœºåˆ¶**

```go
// downloader.go:283-293
if len(errArr) > 0 {
    if !fd.RetryOnError && fd.IsMultiPart {
        // ç¬¬ä¸€æ¬¡å¤±è´¥ï¼Œé™çº§ä¸ºå•çº¿ç¨‹
        fd.RetryOnError = true
        fd.DownloadTaskList = []*DownloadTask{}
        fd.totalTasks = 1
        fd.IsMultiPart = false
        fd.createDownloadTasks()
        return fd.startDownload()  // é‡æ–°å¼€å§‹ä¸‹è½½
    }
    return fmt.Errorf("download failed with %d errors: %v", len(errArr), errArr[0])
}
```

**é™çº§åœºæ™¯**ï¼š
- æœåŠ¡å™¨ä¸æ”¯æŒ Range è¯·æ±‚
- ç½‘ç»œä¸ç¨³å®šå¯¼è‡´åˆ†ç‰‡ä¸‹è½½å¤±è´¥
- æŸäº›åˆ†ç‰‡æ— æ³•ä¸‹è½½

---

### 4.4 èµ„æºæ£€æµ‹ç³»ç»Ÿ (core/resource.go)

#### åŠŸèƒ½èŒè´£
- èµ„æºå»é‡ç®¡ç†ï¼ˆåŸºäº URL MD5ï¼‰
- ä¸‹è½½ä»»åŠ¡ç¼–æ’
- ä¸‹è½½è¿›åº¦äº‹ä»¶å‘é€
- å¾®ä¿¡è§†é¢‘è§£å¯†

#### æ ¸å¿ƒæ•°æ®ç»“æ„

```go
// resource.go:24-29
type Resource struct {
    mediaMark  sync.Map      // å·²æ ‡è®°èµ„æº (urlSign -> bool)
    tasks      sync.Map      // ä¸‹è½½ä»»åŠ¡ (id -> FileDownloader)
    resType    map[string]bool  // å¯ç”¨çš„èµ„æºç±»å‹
    resTypeMux sync.RWMutex  // èµ„æºç±»å‹é”
}
```

#### èµ„æºæ£€æµ‹æµç¨‹

```
HTTP Response â†’ Plugin.OnResponse()
                    â”‚
                    â”œâ”€â–º æå– Content-Type
                    â”‚
                    â”œâ”€â–º æŸ¥è¯¢ MIME æ˜ å°„
                    â”‚   â””â”€â–º è·å– classify, suffix
                    â”‚
                    â”œâ”€â–º æ£€æŸ¥èµ„æºç±»å‹æ˜¯å¦å¯ç”¨
                    â”‚   â”œâ”€â–º GetResType("all")
                    â”‚   â””â”€â–º GetResType(classify)
                    â”‚
                    â”œâ”€â–º ç”Ÿæˆ URL MD5
                    â”‚   â””â”€â–º urlSign = Md5(url)
                    â”‚
                    â”œâ”€â–º å»é‡æ£€æŸ¥
                    â”‚   â””â”€â–º MediaIsMarked(urlSign)
                    â”‚       â”œâ”€â–º true â†’ è·³è¿‡
                    â”‚       â””â”€â–º false â†’ ç»§ç»­
                    â”‚
                    â”œâ”€â–º åˆ›å»º MediaInfo
                    â”‚   â”œâ”€â–º Id = generateId()
                    â”‚   â”œâ”€â–º Url, UrlSign
                    â”‚   â”œâ”€â–º Classify, Suffix
                    â”‚   â”œâ”€â–º ContentType, Size
                    â”‚   â””â”€â–º OtherData (headers, è§£å¯†å¯†é’¥ç­‰)
                    â”‚
                    â”œâ”€â–º æ ‡è®°ä¸ºå·²å¤„ç†
                    â”‚   â””â”€â–º MarkMedia(urlSign)
                    â”‚
                    â”œâ”€â–º å‘é€äº‹ä»¶
                    â”‚   â””â”€â–º Send("newResources", mediaInfo)
                    â”‚
                    â””â”€â–º è¿”å›å“åº”
```

#### ä¸‹è½½ç¼–æ’

```go
// resource.go:100-181
func (r *Resource) download(mediaInfo shared.MediaInfo, decodeStr string) {
    if globalConfig.SaveDirectory == "" {
        return
    }
    go func(mediaInfo shared.MediaInfo) {
        rawUrl := mediaInfo.Url

        // 1. ç”Ÿæˆæ–‡ä»¶å
        fileName := shared.Md5(rawUrl)
        if v := shared.GetFileNameFromURL(rawUrl); v != "" {
            fileName = v
        }
        if mediaInfo.Description != "" {
            // ä½¿ç”¨æè¿°ä½œä¸ºæ–‡ä»¶åï¼ˆå»é™¤éä¸­æ–‡å­—ç¬¦ï¼‰
            fileName = regexp.MustCompile(`[^\w\p{Han}]`).ReplaceAllString(mediaInfo.Description, "")
            fileLen := globalConfig.FilenameLen
            if fileLen <= 0 {
                fileLen = 10
            }
            runes := []rune(fileName)
            if len(runes) > fileLen {
                fileName = string(runes[:fileLen])
            }
        }

        // 2. ç”Ÿæˆä¿å­˜è·¯å¾„
        if globalConfig.FilenameTime {
            mediaInfo.SavePath = filepath.Join(globalConfig.SaveDirectory, fileName+"_"+shared.GetCurrentDateTimeFormatted())
        } else {
            mediaInfo.SavePath = filepath.Join(globalConfig.SaveDirectory, fileName)
        }
        if !strings.HasSuffix(mediaInfo.SavePath, mediaInfo.Suffix) {
            mediaInfo.SavePath = mediaInfo.SavePath + mediaInfo.Suffix
        }

        // 3. å¾®ä¿¡è§†é¢‘ç‰¹æ®Šå¤„ç†ï¼ˆURL æ¸…ç†ï¼‰
        if strings.Contains(rawUrl, "qq.com") {
            if globalConfig.Quality == 1 &&
                strings.Contains(rawUrl, "encfilekey=") &&
                strings.Contains(rawUrl, "token=") {
                // æ¸…ç† URLï¼Œåªä¿ç•™å¿…è¦çš„å‚æ•°
                parseUrl, err := url.Parse(rawUrl)
                if err == nil {
                    queryParams := parseUrl.Query()
                    rawUrl = parseUrl.Scheme + "://" + parseUrl.Host + "/" + parseUrl.Path +
                        "?encfilekey=" + queryParams.Get("encfilekey") +
                        "&token=" + queryParams.Get("token")
                }
            } else if globalConfig.Quality > 1 && mediaInfo.OtherData["wx_file_formats"] != "" {
                // æ ¹æ®è´¨é‡é€‰æ‹©ä¸åŒæ ¼å¼
                format := strings.Split(mediaInfo.OtherData["wx_file_formats"], "#")
                qualityMap := []string{
                    format[0],
                    format[len(format)/2],
                    format[len(format)-1],
                }
                rawUrl += "&X-snsvideoflag=" + qualityMap[globalConfig.Quality-2]
            }
        }

        // 4. è§£æè‡ªå®šä¹‰ Headers
        headers, _ := r.parseHeaders(mediaInfo)

        // 5. åˆ›å»ºä¸‹è½½å™¨
        downloader := NewFileDownloader(rawUrl, mediaInfo.SavePath, globalConfig.TaskNumber, headers)

        // 6. è®¾ç½®è¿›åº¦å›è°ƒ
        downloader.progressCallback = func(totalDownloaded, totalSize float64, taskID int, taskProgress float64) {
            percentage := strconv.Itoa(int(totalDownloaded*100/totalSize)) + "%"
            r.progressEventsEmit(mediaInfo, percentage, shared.DownloadStatusRunning)
        }

        // 7. å­˜å‚¨ä»»åŠ¡
        r.tasks.Store(mediaInfo.Id, downloader)

        // 8. å¼€å§‹ä¸‹è½½
        err := downloader.Start()
        mediaInfo.SavePath = downloader.FileName

        if err != nil {
            if !strings.Contains(err.Error(), "cancelled") {
                r.progressEventsEmit(mediaInfo, err.Error())
            }
            return
        }

        // 9. å¾®ä¿¡è§†é¢‘è§£å¯†
        if decodeStr != "" {
            r.progressEventsEmit(mediaInfo, "decrypting in progress", shared.DownloadStatusRunning)
            if err := r.decodeWxFile(mediaInfo.SavePath, decodeStr); err != nil {
                r.progressEventsEmit(mediaInfo, "decryption error: "+err.Error())
                return
            }
        }

        // 10. å‘é€å®Œæˆäº‹ä»¶
        r.progressEventsEmit(mediaInfo, "complete", shared.DownloadStatusDone)
    }(mediaInfo)
}
```

#### å¾®ä¿¡è§†é¢‘è§£å¯†

```go
// resource.go:247-283
func (r *Resource) decodeWxFile(fileName, decodeStr string) error {
    // 1. Base64 è§£ç å¯†é’¥
    decodedBytes, err := base64.StdEncoding.DecodeString(decodeStr)
    if err != nil {
        return err
    }

    // 2. æ‰“å¼€æ–‡ä»¶
    file, err := os.OpenFile(fileName, os.O_RDWR, 0644)
    if err != nil {
        return err
    }
    defer file.Close()

    // 3. è¯»å–æ–‡ä»¶å¤´éƒ¨
    byteCount := len(decodedBytes)
    fileBytes := make([]byte, byteCount)
    n, err := file.Read(fileBytes)
    if err != nil && err != io.EOF {
        return err
    }

    if n < byteCount {
        byteCount = n
    }

    // 4. XOR è§£å¯†
    xorResult := make([]byte, byteCount)
    for i := 0; i < byteCount; i++ {
        xorResult[i] = decodedBytes[i] ^ fileBytes[i]
    }

    // 5. å†™å›æ–‡ä»¶
    _, err = file.Seek(0, 0)
    if err != nil {
        return err
    }

    _, err = file.Write(xorResult)
    if err != nil {
        return err
    }

    return nil
}
```

**è§£å¯†åŸç†**ï¼š

```
å¾®ä¿¡è§†é¢‘åŠ å¯†æ–¹å¼ï¼š
    æ–‡ä»¶å¤´éƒ¨ N å­—èŠ‚ä½¿ç”¨ XOR åŠ å¯†
    å¯†é’¥ï¼šBase64 ç¼–ç çš„éšæœºå­—èŠ‚åºåˆ—

è§£å¯†è¿‡ç¨‹ï¼š
    1. Base64 è§£ç å¯†é’¥ â†’ keyBytes[]
    2. è¯»å–æ–‡ä»¶å¤´éƒ¨ N å­—èŠ‚ â†’ fileBytes[]
    3. XOR è§£å¯†ï¼šdecryptBytes[i] = keyBytes[i] ^ fileBytes[i]
    4. å†™å›æ–‡ä»¶
```

---

### 4.5 é…ç½®ç®¡ç†ç³»ç»Ÿ (core/config.go)

#### åŠŸèƒ½èŒè´£
- é…ç½®åŠ è½½ä¸ä¿å­˜
- é»˜è®¤é…ç½®ç®¡ç†
- é…ç½®çƒ­æ›´æ–°
- MIME ç±»å‹æ˜ å°„

#### é…ç½®ç»“æ„

```go
// config.go:19-41
type Config struct {
    storage       *Storage              // å­˜å‚¨å±‚
    Theme         string                // ä¸»é¢˜
    Locale        string                // è¯­è¨€
    Host          string                // ä»£ç†åœ°å€
    Port          string                // ä»£ç†ç«¯å£
    Quality       int                   // å¾®ä¿¡è§†é¢‘è´¨é‡
    SaveDirectory string                // ä¿å­˜ç›®å½•
    FilenameLen   int                   // æ–‡ä»¶åé•¿åº¦
    FilenameTime  bool                  // æ˜¯å¦æ·»åŠ æ—¶é—´æˆ³
    UpstreamProxy string                // ä¸Šæ¸¸ä»£ç†
    OpenProxy     bool                  // æ˜¯å¦å¯ç”¨ä»£ç†
    DownloadProxy bool                  // ä¸‹è½½æ—¶æ˜¯å¦ä½¿ç”¨ä»£ç†
    AutoProxy     bool                  // è‡ªåŠ¨ä»£ç†
    WxAction      bool                  // å¾®ä¿¡æ“ä½œ
    TaskNumber    int                   // å¹¶å‘ä»»åŠ¡æ•°
    DownNumber    int                   // åŒæ—¶ä¸‹è½½æ•°
    UserAgent     string                // User-Agent
    UseHeaders    string                // Headers ç­–ç•¥
    InsertTail    bool                  // æ˜¯å¦æ’å…¥å°¾éƒ¨
    MimeMap       map[string]MimeInfo   // MIME æ˜ å°„
    Rule          string                // MITM è§„åˆ™
}
```

#### é»˜è®¤é…ç½®

```go
// config.go:52-73
defaultConfig := &Config{
    Theme:         "lightTheme",
    Locale:        "zh",
    Host:          "127.0.0.1",
    Port:          "8899",
    Quality:       0,
    SaveDirectory: getDefaultDownloadDir(),
    FilenameLen:   0,
    FilenameTime:  true,
    UpstreamProxy: "",
    OpenProxy:     false,
    DownloadProxy: false,
    AutoProxy:     false,
    WxAction:      true,
    TaskNumber:    runtime.NumCPU() * 2,  // CPU æ ¸å¿ƒæ•° Ã— 2
    DownNumber:    3,
    UserAgent:     "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
    UseHeaders:    "default",
    InsertTail:    true,
    MimeMap:       getDefaultMimeMap(),
    Rule:          "*",  // å…¨å±€ MITM
}
```

#### é…ç½®åˆå¹¶ç­–ç•¥

```go
// config.go:100-114
// 1. åŠ è½½é»˜è®¤é…ç½®
var defaultMap map[string]interface{}
defaultBytes, _ := json.Marshal(defaultConfig)
json.Unmarshal(defaultBytes, &defaultMap)

// 2. åŠ è½½ç”¨æˆ·é…ç½®
var cacheMap map[string]interface{}
json.Unmarshal(data, &cacheMap)

// 3. åˆå¹¶ï¼šç”¨æˆ·é…ç½®è¦†ç›–é»˜è®¤å€¼
for k, v := range cacheMap {
    if _, ok := defaultMap[k]; ok {
        defaultMap[k] = v  // åªè¦†ç›–å·²å­˜åœ¨çš„é”®
    }
}

// 4. ä¿å­˜åˆå¹¶åçš„é…ç½®
finalBytes, _ := json.Marshal(defaultMap)
json.Unmarshal(finalBytes, globalConfig)
```

**åˆå¹¶ç­–ç•¥å›¾**ï¼š

```
é»˜è®¤é…ç½®:
    { Theme: "light", Port: "8899", Quality: 0, ... }

ç”¨æˆ·é…ç½® (config.json):
    { Theme: "dark", CustomKey: "value" }

åˆå¹¶ç»“æœ:
    { Theme: "dark", Port: "8899", Quality: 0, ... }
    (CustomKey è¢«å¿½ç•¥ï¼Œåªä¿ç•™å·²çŸ¥å­—æ®µ)
```

#### MIME æ˜ å°„ (180+ æ¡ç›®)

**éƒ¨åˆ†ç¤ºä¾‹**ï¼š

```go
// config.go:119-181
func getDefaultMimeMap() map[string]MimeInfo {
    return map[string]MimeInfo{
        // å›¾ç‰‡
        "image/png":                     {Type: "image", Suffix: ".png"},
        "image/jpeg":                    {Type: "image", Suffix: ".jpg"},
        "image/gif":                     {Type: "image", Suffix: ".gif"},
        "image/webp":                    {Type: "image", Suffix: ".webp"},

        // éŸ³é¢‘
        "audio/mpeg":                    {Type: "audio", Suffix: ".mp3"},
        "audio/wav":                     {Type: "audio", Suffix: ".wav"},
        "audio/flac":                    {Type: "audio", Suffix: ".flac"},

        // è§†é¢‘
        "video/mp4":                     {Type: "video", Suffix: ".mp4"},
        "video/webm":                    {Type: "video", Suffix: ".webm"},
        "video/x-msvideo":               {Type: "video", Suffix: ".avi"},

        // æµåª’ä½“
        "application/vnd.apple.mpegurl": {Type: "m3u8", Suffix: ".m3u8"},
        "application/dash+xml":          {Type: "live", Suffix: ".mpd"},

        // æ–‡æ¡£
        "application/pdf":               {Type: "pdf", Suffix: ".pdf"},
        "application/msword":            {Type: "doc", Suffix: ".doc"},

        // å­—ä½“
        "font/woff":                     {Type: "font", Suffix: ".woff"},

        // å…¶ä»–
        "application/octet-stream":      {Type: "stream", Suffix: "default"},
    }
}
```

#### é…ç½®çƒ­æ›´æ–°

```go
// config.go:209-251
func (c *Config) setConfig(config Config) {
    oldProxy := c.UpstreamProxy
    openProxy := c.OpenProxy
    oldRule := c.Rule

    // æ›´æ–°é…ç½®
    c.Host = config.Host
    c.Port = config.Port
    // ... å…¶ä»–å­—æ®µ

    // çƒ­æ›´æ–°ä»£ç†é…ç½®
    if oldProxy != c.UpstreamProxy || openProxy != c.OpenProxy {
        proxyOnce.setTransport()  // é‡æ–°é…ç½® Transport
    }

    // çƒ­æ›´æ–°è§„åˆ™
    if oldRule != c.Rule {
        ruleOnce.Load(c.Rule)  // é‡æ–°åŠ è½½è§„åˆ™
    }

    // çƒ­æ›´æ–° MIME æ˜ å°„
    mimeMux.Lock()
    c.MimeMap = config.MimeMap
    mimeMux.Unlock()

    // æŒä¹…åŒ–
    jsonData, _ := json.Marshal(c)
    globalConfig.storage.Store(jsonData)
}
```

---

### 4.6 è§„åˆ™å¼•æ“ (core/rule.go)

#### åŠŸèƒ½èŒè´£
- è§£æ MITM è§„åˆ™
- åŸŸååŒ¹é…ï¼ˆæ”¯æŒé€šé…ç¬¦å’Œå¦å®šï¼‰
- å†³å®šæ˜¯å¦å¯¹ç‰¹å®šåŸŸåè¿›è¡Œ MITM

#### è§„åˆ™è¯­æ³•

| è¯­æ³• | ç¤ºä¾‹ | è¯´æ˜ |
|------|------|------|
| `*` | `*` | å…¨å±€åŒ¹é…ï¼ˆæ‰€æœ‰åŸŸåï¼‰ |
| `domain.com` | `qq.com` | ç²¾ç¡®åŒ¹é… |
| `*.domain.com` | `*.qq.com` | é€šé…ç¬¦åŒ¹é…ï¼ˆå­åŸŸåï¼‰ |
| `!domain.com` | `!google.com` | å¦å®šåŒ¹é…ï¼ˆä¸ MITMï¼‰ |
| `#` | `# comment` | æ³¨é‡Š |

#### è§„åˆ™ç»“æ„

```go
// rule.go:10-16
type Rule struct {
    raw        string  // åŸå§‹è§„åˆ™
    isNeg      bool    // æ˜¯å¦å¦å®šè§„åˆ™ï¼ˆä»¥ ! å¼€å¤´ï¼‰
    isWildcard bool    // æ˜¯å¦ä¸º *.domain å½¢å¼
    isAll      bool    // æ˜¯å¦ä¸º *
    domain     string  // åŸŸåéƒ¨åˆ†
}

type RuleSet struct {
    mu    sync.RWMutex  // è¯»å†™é”
    rules []Rule        // è§„åˆ™åˆ—è¡¨
}
```

#### è§„åˆ™è§£æ

```go
// rule.go:35-87
func (r *RuleSet) Load(rs string) error {
    reader := strings.NewReader(rs)
    scanner := bufio.NewScanner(reader)

    var rules []Rule
    for scanner.Scan() {
        line := strings.TrimSpace(scanner.Text())

        // è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
        if line == "" || strings.HasPrefix(line, "#") {
            continue
        }

        // æ£€æŸ¥å¦å®šè§„åˆ™
        isNeg := false
        if strings.HasPrefix(line, "!") {
            isNeg = true
            line = strings.TrimSpace(line[1:])
            if line == "" {
                continue
            }
        }

        // å…¨å±€åŒ¹é…
        if line == "*" {
            rules = append(rules, Rule{
                raw:   "*",
                isAll: true,
                isNeg: isNeg,
            })
            continue
        }

        // é€šé…ç¬¦åŒ¹é…
        isWildcard := false
        domain := line
        if strings.HasPrefix(line, "*.") {
            isWildcard = true
            domain = line[2:]
        }

        rules = append(rules, Rule{
            raw:        line,
            isNeg:      isNeg,
            isWildcard: isWildcard,
            domain:     strings.ToLower(domain),
        })
    }

    r.mu.Lock()
    r.rules = rules
    r.mu.Unlock()

    return nil
}
```

#### åŸŸååŒ¹é…

```go
// rule.go:92-126
func (r *RuleSet) shouldMitm(host string) bool {
    // 1. æå– hostnameï¼ˆå»é™¤ç«¯å£å’Œ IPv6 æ‹¬å·ï¼‰
    h := host
    if strings.HasPrefix(h, "[") {
        if hostSplitIdx := strings.LastIndex(h, "]"); hostSplitIdx != -1 {
            h = h[:hostSplitIdx+1]
        }
    }
    if hp, _, err := net.SplitHostPort(host); err == nil {
        h = hp
    }
    h = strings.ToLower(strings.Trim(h, "[]"))

    r.mu.RLock()
    defer r.mu.RUnlock()

    // 2. éå†è§„åˆ™
    action := false
    for _, rule := range r.rules {
        if rule.isAll {
            action = !rule.isNeg  // * æˆ– !*
            continue
        }

        if rule.isWildcard {
            // *.domain.com åŒ¹é…
            if h == rule.domain || strings.HasSuffix(h, "."+rule.domain) {
                action = !rule.isNeg
            }
            continue
        }

        // ç²¾ç¡®åŒ¹é…
        if h == rule.domain {
            action = !rule.isNeg
        }
    }

    return action
}
```

**åŒ¹é…ç¤ºä¾‹**ï¼š

```
è§„åˆ™:
    *
    !google.com
    *.qq.com

æµ‹è¯•åŸŸå:
    google.com         â†’ false (è¢« !google.com å¦å®š)
    www.qq.com         â†’ true  (åŒ¹é… *.qq.com)
    video.qq.com       â†’ true  (åŒ¹é… *.qq.com)
    qq.com             â†’ false (ä¸åŒ¹é… *.qq.comï¼Œå› ä¸º *.qq.com ä¸åŒ…æ‹¬ qq.com æœ¬èº«)
    douyin.com         â†’ true  (åŒ¹é… *)
```

---

## äº”ã€å‰ç«¯æ¶æ„è¯¦è§£

### 5.1 ç»„ä»¶ç»“æ„

```
App.vue (æ ¹ç»„ä»¶)
 â””â”€ NConfigProvider (Naive UI é…ç½®)
     â”‚   â”œâ”€ ä¸»é¢˜
     â”‚   â””â”€ å›½é™…åŒ–
     â”‚
     â””â”€ NaiveProvider (æ¶ˆæ¯æç¤º)
         â”‚
         â””â”€ RouterView (è·¯ç”±è§†å›¾)
             â”‚
             â””â”€ layout/Index.vue (å¸ƒå±€å®¹å™¨)
                 â”‚
                 â”œâ”€ Sider.vue (ä¾§è¾¹æ )
                 â”‚   â”œâ”€ èµ„æºåˆ—è¡¨
                 â”‚   â”œâ”€ è®¾ç½®
                 â”‚   â””â”€ å…³äº
                 â”‚
                 â””â”€ RouterView (é¡µé¢å†…å®¹)
                     â”œâ”€ views/index.vue (èµ„æºåˆ—è¡¨é¡µ)
                     â”‚   â”œâ”€ èµ„æºå¡ç‰‡
                     â”‚   â”œâ”€ ä¸‹è½½æŒ‰é’®
                     â”‚   â””â”€ è¿›åº¦æ¡
                     â”‚
                     â””â”€ views/setting.vue (è®¾ç½®é¡µ)
                         â”œâ”€ ä»£ç†é…ç½®
                         â”œâ”€ ä¸‹è½½é…ç½®
                         â””â”€ èµ„æºç±»å‹é…ç½®
```

### 5.2 çŠ¶æ€ç®¡ç† (Pinia)

#### Store 1: å…¨å±€çŠ¶æ€ (stores/index.ts)

```typescript
export const useIndexStore = defineStore('index', {
    state: () => ({
        appInfo: {} as AppInfo,           // åº”ç”¨ä¿¡æ¯
        globalConfig: {} as Config,       // å…¨å±€é…ç½®
        isProxy: false,                   // ä»£ç†çŠ¶æ€
        baseUrl: 'http://127.0.0.1:8899'  // API åœ°å€
    }),

    actions: {
        // è·å–åº”ç”¨ä¿¡æ¯
        async getAppInfo() {
            this.appInfo = await Bind.AppInfo()
        },

        // è·å–é…ç½®
        async getConfig() {
            this.globalConfig = await Bind.Config()
        },

        // é‡ç½®åº”ç”¨
        async resetApp() {
            await Bind.ResetApp()
        }
    }
})
```

#### Store 2: äº‹ä»¶å¤„ç† (stores/event.ts)

```typescript
export const useEventStore = defineStore('event', () => {
    const handlers: Record<string, Function> = {
        // æ–°èµ„æºäº‹ä»¶
        newResources: (data: MediaInfo) => {
            // æ·»åŠ åˆ°èµ„æºåˆ—è¡¨
        },

        // ä¸‹è½½è¿›åº¦äº‹ä»¶
        downloadProgress: (data: ProgressData) => {
            // æ›´æ–°ä¸‹è½½è¿›åº¦
        },

        // æ¶ˆæ¯äº‹ä»¶
        message: (data: MessageData) => {
            // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        }
    }

    // æ³¨å†Œäº‹ä»¶ç›‘å¬
    EventsOn("event", (msg: string) => {
        const { type, data } = JSON.parse(msg)
        handlers[type]?.(data)
    })

    return { handlers }
})
```

### 5.3 API é€šä¿¡å±‚

#### Wails ç»‘å®š (ç›´æ¥è°ƒç”¨ Go)

```typescript
// wailsjs/go/core/App.js
export function AppInfo() {
    return window['go']['core']['App']['AppInfo']();
}

export function Config() {
    return window['go']['core']['App']['Config']();
}

export function ResetApp() {
    return window['go']['core']['App']['ResetApp']();
}
```

#### HTTP API (é€šè¿‡ Axios)

```typescript
// frontend/src/api/request.ts
const request = axios.create({
    baseURL: 'http://127.0.0.1:8899',
    timeout: 10000
})

// API ç«¯ç‚¹
export const api = {
    // å®‰è£…ç³»ç»Ÿç»„ä»¶
    install: () => request.post('/api/install'),

    // å¼€å§‹ä¸‹è½½
    download: (mediaInfo: MediaInfo) => request.post('/api/download', mediaInfo),

    // å–æ¶ˆä¸‹è½½
    cancel: (id: string) => request.post('/api/cancel', { id }),

    // æ›´æ–°é…ç½®
    setConfig: (config: Config) => request.post('/api/set-config', config),

    // å¼€å¯ä»£ç†
    proxyOpen: () => request.post('/api/proxy-open'),

    // å…³é—­ä»£ç†
    proxyUnset: () => request.post('/api/proxy-unset')
}
```

### 5.4 é¡µé¢ç»„ä»¶è¯¦è§£

#### (1) èµ„æºåˆ—è¡¨é¡µ (views/index.vue)

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- å±•ç¤ºæ£€æµ‹åˆ°çš„èµ„æº
- ä¸‹è½½æ§åˆ¶ï¼ˆå¼€å§‹/å–æ¶ˆï¼‰
- è¿›åº¦æ˜¾ç¤º
- èµ„æºè¿‡æ»¤ï¼ˆæŒ‰ç±»å‹ï¼‰

**å…³é”®ä»£ç ç‰‡æ®µ**ï¼š

```vue
<template>
    <div class="resource-list">
        <!-- èµ„æºå¡ç‰‡ -->
        <n-card v-for="item in resources" :key="item.Id">
            <!-- å°é¢ -->
            <img :src="item.CoverUrl" />

            <!-- ä¿¡æ¯ -->
            <div>{{ item.Description }}</div>
            <div>{{ item.Size }} MB</div>

            <!-- æ“ä½œ -->
            <n-button
                v-if="item.Status === 'Ready'"
                @click="download(item)"
            >
                ä¸‹è½½
            </n-button>

            <n-button
                v-if="item.Status === 'Running'"
                @click="cancel(item.Id)"
            >
                å–æ¶ˆ
            </n-button>

            <!-- è¿›åº¦ -->
            <n-progress
                v-if="item.Status === 'Running'"
                :percentage="item.Progress"
            />
        </n-card>
    </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { api } from '@/api/request'

const resources = ref<MediaInfo[]>([])

// ç›‘å¬æ–°èµ„æºäº‹ä»¶
EventsOn('event', (msg: string) => {
    const { type, data } = JSON.parse(msg)
    if (type === 'newResources') {
        resources.value.push(data)
    }
})

// ä¸‹è½½
const download = async (item: MediaInfo) => {
    await api.download(item)
}

// å–æ¶ˆ
const cancel = async (id: string) => {
    await api.cancel(id)
}
</script>
```

#### (2) è®¾ç½®é¡µ (views/setting.vue)

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ä»£ç†é…ç½®
- ä¸‹è½½é…ç½®
- èµ„æºç±»å‹é…ç½®
- ä¿å­˜é…ç½®

**é…ç½®é¡¹ç¤ºä¾‹**ï¼š

```vue
<n-form>
    <!-- ä»£ç†é…ç½® -->
    <n-form-item label="ä»£ç†ç«¯å£">
        <n-input-number v-model:value="config.Port" />
    </n-form-item>

    <!-- ä¸‹è½½é…ç½® -->
    <n-form-item label="ä¿å­˜ç›®å½•">
        <n-input v-model:value="config.SaveDirectory" />
    </n-form-item>

    <n-form-item label="å¹¶å‘æ•°">
        <n-input-number v-model:value="config.TaskNumber" />
    </n-form-item>

    <!-- èµ„æºç±»å‹ -->
    <n-form-item label="èµ„æºç±»å‹">
        <n-checkbox-group v-model:value="enabledTypes">
            <n-checkbox value="video">è§†é¢‘</n-checkbox>
            <n-checkbox value="audio">éŸ³é¢‘</n-checkbox>
            <n-checkbox value="image">å›¾ç‰‡</n-checkbox>
        </n-checkbox-group>
    </n-form-item>

    <!-- MITM è§„åˆ™ -->
    <n-form-item label="MITM è§„åˆ™">
        <n-input
            type="textarea"
            v-model:value="config.Rule"
            placeholder="*&#10;!google.com&#10;*.qq.com"
        />
    </n-form-item>

    <!-- ä¿å­˜ -->
    <n-button @click="saveConfig">ä¿å­˜é…ç½®</n-button>
</n-form>
```

---

## å…­ã€å®Œæ•´æ•°æ®æµåˆ†æ

### 6.1 åº”ç”¨å¯åŠ¨æµç¨‹

```
main.go: main()
    â”‚
    â”œâ”€â–º wails.Run()
    â”‚   â”‚
    â”‚   â”œâ”€â–º GetApp(assets, wailsJson)
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â–º æå–ç‰ˆæœ¬å·ï¼ˆä» wails.jsonï¼‰
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â–º åˆ›å»º App å•ä¾‹
    â”‚   â”‚   â”‚   â”œâ”€â–º åµŒå…¥ CA è¯ä¹¦
    â”‚   â”‚   â”‚   â”œâ”€â–º è®¾ç½®ç”¨æˆ·ç›®å½• (~/.config/res-downloader/)
    â”‚   â”‚   â”‚   â””â”€â–º åˆ›å»ºé”æ–‡ä»¶è·¯å¾„
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â–º åˆå§‹åŒ–å­ç³»ç»Ÿ
    â”‚   â”‚   â”‚   â”œâ”€â–º initLogger()     â†’ æ—¥å¿—ç³»ç»Ÿ
    â”‚   â”‚   â”‚   â”œâ”€â–º initConfig()     â†’ é…ç½®ç®¡ç†
    â”‚   â”‚   â”‚   â”œâ”€â–º initProxy()      â†’ ä»£ç†æœåŠ¡å™¨
    â”‚   â”‚   â”‚   â”œâ”€â–º initResource()   â†’ èµ„æºç®¡ç†
    â”‚   â”‚   â”‚   â”œâ”€â–º initHttpServer() â†’ HTTP API
    â”‚   â”‚   â”‚   â”œâ”€â–º initSystem()     â†’ ç³»ç»Ÿé›†æˆ
    â”‚   â”‚   â”‚   â””â”€â–º initRule()       â†’ è§„åˆ™å¼•æ“
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€â–º è¿”å› App å®ä¾‹
    â”‚   â”‚
    â”‚   â”œâ”€â–º app.Startup(ctx)
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€â–º go httpServerOnce.run()
    â”‚   â”‚       â””â”€â–º å¯åŠ¨ HTTP æœåŠ¡ç›‘å¬ 127.0.0.1:8899
    â”‚   â”‚
    â”‚   â”œâ”€â–º åŠ è½½å‰ç«¯èµ„æº
    â”‚   â”‚
    â”‚   â””â”€â–º æ‰“å¼€çª—å£
    â”‚
    â””â”€â–º åº”ç”¨è¿è¡Œä¸­
```

### 6.2 èµ„æºæ£€æµ‹å®Œæ•´æµç¨‹

```
æµè§ˆå™¨è®¿é—® https://video.qq.com/sample.mp4
    â”‚
    â”œâ”€â–º ç³»ç»Ÿä»£ç†è®¾ç½® (127.0.0.1:8899)
    â”‚
    â–¼
Proxy Server æ¥æ”¶ CONNECT è¯·æ±‚
    â”‚
    â”œâ”€â–º HandleConnectFunc
    â”‚   â”‚
    â”‚   â”œâ”€â–º ruleOnce.shouldMitm("video.qq.com")
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â–º æ£€æŸ¥è§„åˆ™: "*"
    â”‚   â”‚   â”‚   â””â”€â–º isAll=true, isNeg=false â†’ action=true
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€â–º è¿”å› true
    â”‚   â”‚
    â”‚   â””â”€â–º è¿”å› MitmConnect (è§£å¯† HTTPS)
    â”‚
    â”œâ”€â–º å»ºç«‹ TLS è¿æ¥ï¼ˆä½¿ç”¨ goproxy CAï¼‰
    â”‚
    â–¼
æµè§ˆå™¨å‘é€ GET /sample.mp4
    â”‚
    â”œâ”€â–º Proxy.OnRequest
    â”‚   â”‚
    â”‚   â”œâ”€â–º matchPlugin("video.qq.com")
    â”‚   â”‚   â””â”€â–º è¿”å› QqPlugin
    â”‚   â”‚
    â”‚   â”œâ”€â–º QqPlugin.OnRequest()
    â”‚   â”‚   â””â”€â–º è¿”å› (req, nil) â†’ ç»§ç»­è½¬å‘
    â”‚   â”‚
    â””â”€â–º è½¬å‘è¯·æ±‚åˆ°ç›®æ ‡æœåŠ¡å™¨
                â”‚
                â–¼
ç›®æ ‡æœåŠ¡å™¨è¿”å›å“åº” (200 OK, Content-Type: video/mp4)
    â”‚
    â”œâ”€â–º Proxy.OnResponse
    â”‚   â”‚
    â”‚   â”œâ”€â–º matchPlugin("video.qq.com")
    â”‚   â”‚   â””â”€â–º è¿”å› QqPlugin
    â”‚   â”‚
    â”‚   â”œâ”€â–º QqPlugin.OnResponse()
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â–º æ£€æŸ¥ Content-Type: "video/mp4"
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â–º TypeSuffix("video/mp4")
    â”‚   â”‚   â”‚   â””â”€â–º è¿”å› ("video", ".mp4")
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â–º GetResType("video")
    â”‚   â”‚   â”‚   â””â”€â–º è¿”å› (true, true) â†’ å·²å¯ç”¨
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â–º ç”Ÿæˆ URL MD5
    â”‚   â”‚   â”‚   â””â”€â–º urlSign = Md5(url)
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â–º MediaIsMarked(urlSign)
    â”‚   â”‚   â”‚   â””â”€â–º è¿”å› false â†’ æœªå¤„ç†
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â–º åˆ›å»º MediaInfo
    â”‚   â”‚   â”‚   â””â”€â–º {
    â”‚   â”‚   â”‚       Id: generateId(),
    â”‚   â”‚   â”‚       Url: "https://video.qq.com/sample.mp4",
    â”‚   â”‚   â”‚       UrlSign: urlSign,
    â”‚   â”‚   â”‚       Domain: "qq.com",
    â”‚   â”‚   â”‚       Classify: "video",
    â”‚   â”‚   â”‚       Suffix: ".mp4",
    â”‚   â”‚   â”‚       Status: "Ready",
    â”‚   â”‚   â”‚       ContentType: "video/mp4",
    â”‚   â”‚   â”‚       Size: 10485760
    â”‚   â”‚   â”‚   }
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â–º MarkMedia(urlSign)
    â”‚   â”‚   â”‚   â””â”€â–º æ ‡è®°ä¸ºå·²å¤„ç†
    â”‚   â”‚   â”‚
    â”‚   â”‚   â”œâ”€â–º Send("newResources", mediaInfo)
    â”‚   â”‚   â”‚   â””â”€â–º httpServerOnce.send()
    â”‚   â”‚   â”‚       â””â”€â–º runtime.EventsEmit("event", JSON)
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€â–º è¿”å›å“åº”
    â”‚   â”‚
    â””â”€â–º è¿”å›å“åº”ç»™æµè§ˆå™¨
                â”‚
                â–¼
å‰ç«¯æ¥æ”¶äº‹ä»¶
    â”‚
    â”œâ”€â–º EventsOn("event", handler)
    â”‚
    â”œâ”€â–º JSON.parse(msg)
    â”‚   â””â”€â–º { type: "newResources", data: MediaInfo }
    â”‚
    â”œâ”€â–º handlers["newResources"](data)
    â”‚   â”‚
    â”‚   â”œâ”€â–º æ·»åŠ åˆ°èµ„æºåˆ—è¡¨
    â”‚   â”‚
    â”‚   â””â”€â–º UI æ›´æ–°
    â”‚
    â””â”€â–º æ˜¾ç¤ºèµ„æºå¡ç‰‡
```

### 6.3 ä¸‹è½½å®Œæ•´æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"ä¸‹è½½"æŒ‰é’®
    â”‚
    â”œâ”€â–º å‰ç«¯éªŒè¯
    â”‚   â”œâ”€â–º æ£€æŸ¥ä¿å­˜è·¯å¾„
    â”‚   â”œâ”€â–º æ£€æŸ¥å¹¶å‘æ•°
    â”‚   â””â”€â–º æ£€æŸ¥é˜Ÿåˆ—çŠ¶æ€
    â”‚
    â”œâ”€â–º POST /api/download
    â”‚   Body: { Id, Url, ... }
    â”‚
    â–¼
åç«¯æ¥æ”¶è¯·æ±‚ (http.go:HandleApi)
    â”‚
    â”œâ”€â–º è·¯ç”±åŒ¹é…: /download
    â”‚
    â”œâ”€â–º resource.download(mediaInfo, decodeStr)
    â”‚   â”‚
    â”‚   â”œâ”€â–º ç”Ÿæˆæ–‡ä»¶å
    â”‚   â”‚   â”œâ”€â–º ä» URL æå–æ–‡ä»¶å
    â”‚   â”‚   â”œâ”€â–º æˆ–ä½¿ç”¨ Descriptionï¼ˆå»ç‰¹æ®Šå­—ç¬¦ï¼‰
    â”‚   â”‚   â””â”€â–º æ·»åŠ æ—¶é—´æˆ³ï¼ˆå¦‚æœé…ç½®ï¼‰
    â”‚   â”‚
    â”‚   â”œâ”€â–º ç”Ÿæˆä¿å­˜è·¯å¾„
    â”‚   â”‚   â””â”€â–º SaveDirectory + Filename + Suffix
    â”‚   â”‚
    â”‚   â”œâ”€â–º è§£æ Headers
    â”‚   â”‚   â””â”€â–º ä» OtherData["headers"] è§£æ
    â”‚   â”‚
    â”‚   â”œâ”€â–º åˆ›å»º FileDownloader
    â”‚   â”‚   â”œâ”€â–º NewFileDownloader(url, filename, taskNumber, headers)
    â”‚   â”‚   â””â”€â–º è®¾ç½®è¿›åº¦å›è°ƒ
    â”‚   â”‚
    â”‚   â”œâ”€â–º å­˜å‚¨ä»»åŠ¡
    â”‚   â”‚   â””â”€â–º tasks.Store(id, downloader)
    â”‚   â”‚
    â”‚   â””â”€â–º downloader.Start()
    â”‚       â”‚
    â”‚       â”œâ”€â–º init()
    â”‚       â”‚   â”œâ”€â–º å‘é€ HEAD è¯·æ±‚
    â”‚       â”‚   â”œâ”€â–º è·å–æ–‡ä»¶å¤§å°: 100MB
    â”‚       â”‚   â”œâ”€â–º æ£€æŸ¥ Accept-Ranges: bytes
    â”‚       â”‚   â”œâ”€â–º åˆ›å»ºæ–‡ä»¶å¹¶é¢„åˆ†é…
    â”‚       â”‚   â””â”€â–º IsMultiPart = true
    â”‚       â”‚
    â”‚       â”œâ”€â–º createDownloadTasks()
    â”‚       â”‚   â”œâ”€â–º å¹¶å‘æ•° = 8
    â”‚       â”‚   â”œâ”€â–º æ¯ç‰‡å¤§å° = 100MB / 8 = 12.5MB
    â”‚       â”‚   â””â”€â–º åˆ›å»º 8 ä¸ª DownloadTask
    â”‚       â”‚
    â”‚       â””â”€â–º startDownload()
    â”‚           â”‚
    â”‚           â”œâ”€â–º å¯åŠ¨ 8 ä¸ª goroutines
    â”‚           â”‚
    â”‚           â”œâ”€â–º Goroutine 1 (Task 0)
    â”‚           â”‚   â”œâ”€â–º GET /sample.mp4
    â”‚           â”‚   â”œâ”€â–º Range: bytes=0-13107199
    â”‚           â”‚   â”œâ”€â–º ä¸‹è½½ 0-12.5MB
    â”‚           â”‚   â”œâ”€â–º å†™å…¥æ–‡ä»¶ [0-12.5MB)
    â”‚           â”‚   â””â”€â–º å‘é€è¿›åº¦ â†’ progressChan
    â”‚           â”‚
    â”‚           â”œâ”€â–º Goroutine 2 (Task 1)
    â”‚           â”‚   â”œâ”€â–º GET /sample.mp4
    â”‚           â”‚   â”œâ”€â–º Range: bytes=13107200-26214399
    â”‚           â”‚   â”œâ”€â–º ä¸‹è½½ 12.5MB-25MB
    â”‚           â”‚   â”œâ”€â–º å†™å…¥æ–‡ä»¶ [12.5MB-25MB)
    â”‚           â”‚   â””â”€â–º å‘é€è¿›åº¦ â†’ progressChan
    â”‚           â”‚
    â”‚           â”œâ”€â–º ... (Task 2-7)
    â”‚           â”‚
    â”‚           â”œâ”€â–º Progress Aggregator
    â”‚           â”‚   â”œâ”€â–º æ¥æ”¶è¿›åº¦
    â”‚           â”‚   â”œâ”€â–º è®¡ç®—æ€»è¿›åº¦
    â”‚           â”‚   â”œâ”€â–º è®¡ç®—ä»»åŠ¡è¿›åº¦
    â”‚           â”‚   â””â”€â–º å›è°ƒ progressCallback
    â”‚           â”‚       â”‚
    â”‚           â”‚       â””â”€â–º progressEventsEmit()
    â”‚           â”‚           â””â”€â–º httpServerOnce.send("downloadProgress", {...})
    â”‚           â”‚               â””â”€â–º runtime.EventsEmit("event", JSON)
    â”‚           â”‚
    â”‚           â””â”€â–º æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    â”‚               â”‚
    â”‚               â”œâ”€â–º verifyDownload()
    â”‚               â”‚   â””â”€â–º æ£€æŸ¥æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    â”‚               â”‚
    â”‚               â”œâ”€â–º å…³é—­æ–‡ä»¶
    â”‚               â”‚
    â”‚               â”œâ”€â–º æ£€æŸ¥æ˜¯å¦éœ€è¦è§£å¯†
    â”‚               â”‚   â”œâ”€â–º decodeStr != ""
    â”‚               â”‚   â””â”€â–º decodeWxFile()
    â”‚               â”‚       â”œâ”€â–º Base64 è§£ç å¯†é’¥
    â”‚               â”‚       â”œâ”€â–º XOR è§£å¯†æ–‡ä»¶å¤´éƒ¨
    â”‚               â”‚       â””â”€â–º å†™å›æ–‡ä»¶
    â”‚               â”‚
    â”‚               â””â”€â–º å‘é€å®Œæˆäº‹ä»¶
    â”‚                   â””â”€â–º progressEventsEmit(mediaInfo, "complete", "Done")
    â”‚
    â–¼
å‰ç«¯æ¥æ”¶è¿›åº¦äº‹ä»¶
    â”‚
    â”œâ”€â–º EventsOn("event", handler)
    â”‚
    â”œâ”€â–º JSON.parse(msg)
    â”‚   â””â”€â–º { type: "downloadProgress", data: { Id, Status, Message } }
    â”‚
    â”œâ”€â–º handlers["downloadProgress"](data)
    â”‚   â”‚
    â”‚   â”œâ”€â–º æŸ¥æ‰¾å¯¹åº”èµ„æº
    â”‚   â”‚
    â”‚   â”œâ”€â–º æ›´æ–°çŠ¶æ€
    â”‚   â”‚   â”œâ”€â–º Status = "Running"
    â”‚   â”‚   â”œâ”€â–º Message = "45%"
    â”‚   â”‚   â””â”€â–º Progress = 45
    â”‚   â”‚
    â”‚   â””â”€â–º UI æ›´æ–°
    â”‚       â””â”€â–º è¿›åº¦æ¡æ›´æ–°
    â”‚
    â–¼
å‰ç«¯æ¥æ”¶å®Œæˆäº‹ä»¶
    â”‚
    â”œâ”€â–º handlers["downloadProgress"]({ Status: "Done", Message: "complete" })
    â”‚
    â”œâ”€â–º æ›´æ–°çŠ¶æ€
    â”‚   â”œâ”€â–º Status = "Done"
    â”‚   â”œâ”€â–º Message = "complete"
    â”‚   â””â”€â–º Progress = 100
    â”‚
    â””â”€â–º UI æ›´æ–°
        â”œâ”€â–º éšè—è¿›åº¦æ¡
        â”œâ”€â–º æ˜¾ç¤º"æ‰“å¼€"æŒ‰é’®
        â””â”€â–º æ˜¾ç¤ºæ–‡ä»¶è·¯å¾„
```

### 6.4 äº‹ä»¶ç³»ç»Ÿæ¶æ„

**åç«¯å‘é€** (http.go:111-121)ï¼š

```go
func send(t string, data interface{}) {
    jsonData, _ := json.Marshal(map[string]interface{}{
        "type": t,
        "data": data,
    })
    runtime.EventsEmit(ctx, "event", string(jsonData))
}
```

**å‰ç«¯æ¥æ”¶** (stores/event.ts)ï¼š

```typescript
EventsOn("event", (msg: string) => {
    const { type, data } = JSON.parse(msg)

    const handlers: Record<string, Function> = {
        newResources: (data: MediaInfo) => {
            // å¤„ç†æ–°èµ„æº
            resources.value.push(data)
        },

        downloadProgress: (data: ProgressData) => {
            // å¤„ç†ä¸‹è½½è¿›åº¦
            const resource = resources.value.find(r => r.Id === data.Id)
            if (resource) {
                resource.Status = data.Status
                resource.Message = data.Message
                resource.Progress = parseProgress(data.Message)
            }
        },

        message: (data: MessageData) => {
            // æ˜¾ç¤ºæ¶ˆæ¯
            message[data.type](data.content)
        }
    }

    handlers[type]?.(data)
})
```

**äº‹ä»¶ç±»å‹æ±‡æ€»**ï¼š

| äº‹ä»¶ç±»å‹ | æ•°æ®ç»“æ„ | è§¦å‘æ—¶æœº |
|---------|---------|----------|
| `newResources` | `MediaInfo` | æ£€æµ‹åˆ°æ–°èµ„æº |
| `downloadProgress` | `{Id, Status, SavePath, Message}` | ä¸‹è½½è¿›åº¦æ›´æ–° |
| `message` | `{type, content}` | ä¸€èˆ¬æ¶ˆæ¯é€šçŸ¥ |

---

## ä¸ƒã€äºŒæ¬¡å¼€å‘æŒ‡å—

### 7.1 å¦‚ä½•æ·»åŠ æ–°æ’ä»¶

#### æ­¥éª¤ 1: åˆ›å»ºæ’ä»¶æ–‡ä»¶

åœ¨ `core/plugins/` ç›®å½•ä¸‹åˆ›å»ºæ–°æ–‡ä»¶ï¼Œä¾‹å¦‚ `plugin.example.com.go`ï¼š

```go
package plugins

import (
    "github.com/elazarl/goproxy"
    "net/http"
    "res-downloader/core/shared"
)

type ExamplePlugin struct {
    bridge *shared.Bridge
}
```

#### æ­¥éª¤ 2: å®ç°æ’ä»¶æ¥å£

```go
// 1. SetBridge - æ³¨å…¥ä¾èµ–
func (p *ExamplePlugin) SetBridge(bridge *shared.Bridge) {
    p.bridge = bridge
}

// 2. Domains - å£°æ˜å¤„ç†çš„åŸŸå
func (p *ExamplePlugin) Domains() []string {
    return []string{"example.com", "www.example.com"}
}

// 3. OnRequest - è¯·æ±‚å¤„ç†
func (p *ExamplePlugin) OnRequest(r *http.Request, ctx *goproxy.ProxyCtx) (*http.Request, *http.Response) {
    // å¯ä»¥ä¿®æ”¹è¯·æ±‚æˆ–è¿”å›è‡ªå®šä¹‰å“åº”

    // ç¤ºä¾‹ï¼šä¿®æ”¹è¯·æ±‚å¤´
    // r.Header.Set("Custom-Header", "value")

    // ç¤ºä¾‹ï¼šè¿”å›è‡ªå®šä¹‰å“åº”
    // return r, &http.Response{...}

    // è¿”å› nil, nil è¡¨ç¤ºç»§ç»­è½¬å‘
    return r, nil
}

// 4. OnResponse - å“åº”å¤„ç†
func (p *ExamplePlugin) OnResponse(resp *http.Response, ctx *goproxy.ProxyCtx) *http.Response {
    if resp == nil || resp.Request == nil {
        return resp
    }

    // æ£€æŸ¥å“åº”ç 
    if resp.StatusCode != 200 && resp.StatusCode != 206 {
        return resp
    }

    // è·å– Content-Type
    contentType := resp.Header.Get("Content-Type")

    // æŸ¥è¯¢ MIME æ˜ å°„
    classify, suffix := p.bridge.TypeSuffix(contentType)

    // å¦‚æœä¸æ˜¯ç›®æ ‡èµ„æºç±»å‹ï¼Œç›´æ¥è¿”å›
    if classify == "" {
        return resp
    }

    // æ£€æŸ¥èµ„æºç±»å‹æ˜¯å¦å¯ç”¨
    isAll, _ := p.bridge.GetResType("all")
    isType, _ := p.bridge.GetResType(classify)
    if !isAll && !isType {
        return resp
    }

    // æå– URL
    url := resp.Request.URL.String()

    // ç”Ÿæˆ MD5 ç­¾å
    urlSign := shared.Md5(url)

    // å»é‡æ£€æŸ¥
    if p.bridge.MediaIsMarked(urlSign) {
        return resp
    }

    // åˆ›å»º MediaInfo
    mediaInfo := shared.MediaInfo{
        Id:          shared.GenerateId(),
        Url:         url,
        UrlSign:     urlSign,
        Domain:      shared.GetTopLevelDomain(url),
        Classify:    classify,
        Suffix:      suffix,
        Status:      shared.DownloadStatusReady,
        ContentType: contentType,
        OtherData:   map[string]string{},
    }

    // æå–æ–‡ä»¶å¤§å°
    if resp.ContentLength > 0 {
        mediaInfo.Size = float64(resp.ContentLength)
    }

    // æå– Headers
    headersMap := make(map[string][]string)
    for key, values := range resp.Header {
        headersMap[key] = values
    }
    if jsonData, err := json.Marshal(headersMap); err == nil {
        mediaInfo.OtherData["headers"] = string(jsonData)
    }

    // æ ‡è®°ä¸ºå·²å¤„ç†
    p.bridge.MarkMedia(urlSign)

    // å‘é€äº‹ä»¶åˆ°å‰ç«¯
    p.bridge.Send("newResources", mediaInfo)

    return resp
}
```

#### æ­¥éª¤ 3: æ³¨å†Œæ’ä»¶

åœ¨ `core/proxy.go` çš„ `init()` å‡½æ•°ä¸­æ³¨å†Œï¼š

```go
// proxy.go:26-30
func init() {
    ps := []shared.Plugin{
        &plugins.QqPlugin{},
        &plugins.DefaultPlugin{},
        &plugins.ExamplePlugin{},  // æ·»åŠ è¿™ä¸€è¡Œ
    }

    // ... å…¶ä½™ä»£ç 
}
```

#### æ­¥éª¤ 4: ç¼–è¯‘æµ‹è¯•

```bash
# å¼€å‘æ¨¡å¼
wails dev

# ç¼–è¯‘ç”Ÿäº§ç‰ˆæœ¬
wails build
```

---

### 7.2 å¦‚ä½•æ‰©å±•é…ç½®é¡¹

#### æ­¥éª¤ 1: ä¿®æ”¹ Config ç»“æ„

åœ¨ `core/config.go` ä¸­æ·»åŠ æ–°å­—æ®µï¼š

```go
// config.go:19-41
type Config struct {
    // ... ç°æœ‰å­—æ®µ

    MyNewConfig string `json:"MyNewConfig"`  // æ–°å¢é…ç½®é¡¹
}
```

#### æ­¥éª¤ 2: æ·»åŠ é»˜è®¤å€¼

åœ¨ `core/config.go` çš„ `initConfig()` å‡½æ•°ä¸­ï¼š

```go
// config.go:52-73
defaultConfig := &Config{
    // ... ç°æœ‰é…ç½®
    MyNewConfig: "default_value",  // æ–°å¢é»˜è®¤å€¼
}
```

#### æ­¥éª¤ 3: æ·»åŠ  Getter

åœ¨ `core/config.go` çš„ `getConfig()` å‡½æ•°ä¸­ï¼š

```go
// config.go:253-300
func (c *Config) getConfig(key string) interface{} {
    switch key {
    // ... ç°æœ‰ case
    case "MyNewConfig":
        return c.MyNewConfig
    default:
        return nil
    }
}
```

#### æ­¥éª¤ 4: å‰ç«¯æ·»åŠ  UI

åœ¨ `frontend/src/views/setting.vue` ä¸­ï¼š

```vue
<n-form-item label="æ–°é…ç½®é¡¹">
    <n-input v-model:value="config.MyNewConfig" />
</n-form-item>
```

---

### 7.3 å¦‚ä½•ä¿®æ”¹ä¸‹è½½é€»è¾‘

#### åœºæ™¯ 1: æ·»åŠ ä¸‹è½½é€Ÿåº¦é™åˆ¶

åœ¨ `core/downloader.go` ä¸­ä¿®æ”¹ï¼š

```go
// downloader.go:39-54
type FileDownloader struct {
    // ... ç°æœ‰å­—æ®µ
    MaxSpeed int64  // æ–°å¢ï¼šæœ€å¤§é€Ÿåº¦ï¼ˆå­—èŠ‚/ç§’ï¼‰
}

// downloader.go:334-398 (doDownloadTask)
func (fd *FileDownloader) doDownloadTask(progressChan chan ProgressChan, task *DownloadTask) error {
    // ... ç°æœ‰ä»£ç 

    buf := make([]byte, 32*1024)
    for {
        n, err := resp.Body.Read(buf)
        if n > 0 {
            // é€Ÿåº¦é™åˆ¶é€»è¾‘
            if fd.MaxSpeed > 0 {
                // è®¡ç®—éœ€è¦çš„å»¶è¿Ÿæ—¶é—´
                delay := time.Duration(n*1e6/fd.MaxSpeed) * time.Microsecond
                time.Sleep(delay)
            }

            // ... å†™å…¥æ–‡ä»¶
        }
        // ...
    }
}
```

#### åœºæ™¯ 2: æ·»åŠ ä¸‹è½½ä¼˜å…ˆçº§

åœ¨ `core/resource.go` ä¸­ä¿®æ”¹ï¼š

```go
// resource.go:100-181
func (r *Resource) download(mediaInfo shared.MediaInfo, decodeStr string) {
    // æ–°å¢ï¼šä¼˜å…ˆçº§åˆ¤æ–­
    if mediaInfo.Priority == "high" {
        // ç«‹å³ä¸‹è½½ï¼Œä¸å—é˜Ÿåˆ—é™åˆ¶
        go r.doDownload(mediaInfo, decodeStr)
    } else {
        // åŠ å…¥é˜Ÿåˆ—ï¼Œç­‰å¾…ç©ºé—²
        r.downloadQueue = append(r.downloadQueue, DownloadTask{
            MediaInfo: mediaInfo,
            DecodeStr: decodeStr,
        })
    }
}
```

#### åœºæ™¯ 3: æ·»åŠ ä¸‹è½½å®Œæˆåå¤„ç†

åœ¨ `core/resource.go` çš„ `download()` å‡½æ•°ä¸­ï¼š

```go
// resource.go:100-181
func (r *Resource) download(mediaInfo shared.MediaInfo, decodeStr string) {
    // ... ä¸‹è½½å®Œæˆ

    if err != nil {
        // ... é”™è¯¯å¤„ç†
        return
    }

    // æ–°å¢ï¼šä¸‹è½½åå¤„ç†
    if mediaInfo.Classify == "video" {
        // è‡ªåŠ¨ç”Ÿæˆç¼©ç•¥å›¾
        go r.generateThumbnail(mediaInfo.SavePath)
    }

    if decodeStr != "" {
        // ... è§£å¯†
    }

    // å‘é€å®Œæˆäº‹ä»¶
    r.progressEventsEmit(mediaInfo, "complete", shared.DownloadStatusDone)
}
```

---

### 7.4 å¦‚ä½•æ·»åŠ æ–°çš„ MIME ç±»å‹

åœ¨ `core/config.go` çš„ `getDefaultMimeMap()` å‡½æ•°ä¸­ï¼š

```go
// config.go:119-181
func getDefaultMimeMap() map[string]MimeInfo {
    return map[string]MimeInfo{
        // ... ç°æœ‰æ˜ å°„

        // æ–°å¢ï¼šæ”¯æŒæ–°çš„ MIME ç±»å‹
        "application/x-new-type": {Type: "custom", Suffix: ".custom"},
        "video/x-matroska":       {Type: "video",  Suffix: ".mkv"},
        "audio/x-m4a":            {Type: "audio",  Suffix: ".m4a"},
    }
}
```

---

### 7.5 å¦‚ä½•æ·»åŠ æ–°çš„å‰ç«¯é¡µé¢

#### æ­¥éª¤ 1: åˆ›å»ºé¡µé¢ç»„ä»¶

åœ¨ `frontend/src/views/` åˆ›å»ºæ–°æ–‡ä»¶ `about.vue`ï¼š

```vue
<template>
    <div class="about-page">
        <n-card title="å…³äº">
            <p>{{ appInfo.Description }}</p>
            <p>ç‰ˆæœ¬: {{ appInfo.Version }}</p>
            <p>ç‰ˆæƒ: {{ appInfo.Copyright }}</p>
        </n-card>
    </div>
</template>

<script setup lang="ts">
import { useIndexStore } from '@/stores/index'

const indexStore = useIndexStore()
const { appInfo } = storeToRefs(indexStore)
</script>
```

#### æ­¥éª¤ 2: æ·»åŠ è·¯ç”±

åœ¨ `frontend/src/router/index.ts` ä¸­ï¼š

```typescript
import AboutView from '@/views/about.vue'

const routes = [
    // ... ç°æœ‰è·¯ç”±
    {
        path: '/about',
        name: 'About',
        component: AboutView
    }
]
```

#### æ­¥éª¤ 3: æ·»åŠ å¯¼èˆª

åœ¨ `frontend/src/components/Sider.vue` ä¸­ï¼š

```vue
<n-menu-item key="about" @click="navigate('/about')">
    <template #icon>
        <n-icon :component="InformationCircleIcon" />
    </template>
    å…³äº
</n-menu-item>
```

---

### 7.6 å¦‚ä½•è°ƒè¯•ä»£ç 

#### åç«¯è°ƒè¯•

```go
// ä½¿ç”¨ zerolog è¾“å‡ºæ—¥å¿—
globalLogger.Debug().Msgf("Debug info: %+v", data)
globalLogger.Info().Msg("Info message")
globalLogger.Warn().Msg("Warning message")
globalLogger.Error().Err(err).Msg("Error message")
```

#### å‰ç«¯è°ƒè¯•

```typescript
// ä½¿ç”¨ console è¾“å‡º
console.log('Debug info:', data)
console.warn('Warning:', message)
console.error('Error:', error)

// ä½¿ç”¨ Vue Devtools
// åœ¨æµè§ˆå™¨ä¸­å®‰è£… Vue Devtools æ‰©å±•
```

#### ä»£ç†è°ƒè¯•

```bash
# ä½¿ç”¨ curl æµ‹è¯•ä»£ç†
curl -x http://127.0.0.1:8899 https://example.com

# æŸ¥çœ‹ä»£ç†æ—¥å¿—
# æ—¥å¿—æ–‡ä»¶ä½ç½®: ~/.config/res-downloader/logs/
```

---

## å…«ã€å…³é”®æ–‡ä»¶é€ŸæŸ¥è¡¨

### 8.1 æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶ | åŠŸèƒ½ | å…³é”®å†…å®¹ | ä»£ç è¡Œæ•° |
|------|------|----------|----------|
| `main.go` | ç¨‹åºå…¥å£ | Wails åº”ç”¨åˆå§‹åŒ–ã€å‰ç«¯èµ„æºåµŒå…¥ | ~50 |
| `core/app.go` | åº”ç”¨å•ä¾‹ | ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€CA è¯ä¹¦ã€å…¨å±€å•ä¾‹åˆå§‹åŒ– | ~212 |
| `core/proxy.go` | ä»£ç†æœåŠ¡å™¨ | MITM å®ç°ã€æ’ä»¶è·¯ç”±ã€è¯·æ±‚/å“åº”å¤„ç† | ~174 |
| `core/http.go` | HTTP API | API ç«¯ç‚¹å¤„ç†ã€äº‹ä»¶å‘é€ã€Wails æ¡¥æ¥ | ~150 |
| `core/downloader.go` | ä¸‹è½½å¼•æ“ | å¤šçº¿ç¨‹ä¸‹è½½ã€Range è¯·æ±‚ã€è¿›åº¦æŠ¥å‘Š | ~445 |
| `core/resource.go` | èµ„æºç®¡ç† | èµ„æºæ£€æµ‹ã€ä¸‹è½½ç¼–æ’ã€å»é‡ç®¡ç†ã€è§£å¯† | ~284 |
| `core/config.go` | é…ç½®ç®¡ç† | é…ç½®åŠ è½½/ä¿å­˜ã€MIME æ˜ å°„ã€çƒ­æ›´æ–° | ~311 |
| `core/rule.go` | è§„åˆ™å¼•æ“ | è§„åˆ™è§£æã€åŸŸååŒ¹é…ã€MITM å†³ç­– | ~127 |
| `core/logger.go` | æ—¥å¿—ç³»ç»Ÿ | ç»“æ„åŒ–æ—¥å¿—ã€æ–‡ä»¶è½®è½¬ | ~80 |
| `core/storage.go` | å­˜å‚¨å±‚ | JSON æ–‡ä»¶æŒä¹…åŒ– | ~60 |

### 8.2 æ’ä»¶æ–‡ä»¶

| æ–‡ä»¶ | å¤„ç†åŸŸå | ç‰¹æ®ŠåŠŸèƒ½ |
|------|----------|----------|
| `core/plugins/plugin.default.go` | æ‰€æœ‰åŸŸå (é»˜è®¤) | é€šç”¨èµ„æºæ£€æµ‹ï¼ˆåŸºäº Content-Typeï¼‰ |
| `core/plugins/plugin.qq.com.go` | qq.com | JS æ³¨å…¥ã€å¾®ä¿¡è§†é¢‘è§£å¯†ã€è‡ªå®šä¹‰è¯·æ±‚å¤„ç† |

### 8.3 ç³»ç»Ÿé›†æˆæ–‡ä»¶

| æ–‡ä»¶ | å¹³å° | åŠŸèƒ½ |
|------|------|------|
| `core/system_windows.go` | Windows | æ³¨å†Œè¡¨ä»£ç†è®¾ç½®ã€è¯ä¹¦å®‰è£… |
| `core/system_darwin.go` | macOS | scutil ç½‘ç»œé…ç½®ã€Keychain è¯ä¹¦ |
| `core/system_linux.go` | Linux | gsettings/ç¯å¢ƒå˜é‡ã€è¯ä¹¦ä¿¡ä»»å­˜å‚¨ |

### 8.4 å…±äº«ä»£ç æ–‡ä»¶

| æ–‡ä»¶ | åŠŸèƒ½ | å…³é”®å†…å®¹ |
|------|------|----------|
| `core/shared/plugin.go` | æ’ä»¶æ¥å£ | Plugin æ¥å£ã€Bridge ç»“æ„ |
| `core/shared/base.go` | åŸºç¡€ç±»å‹ | MediaInfo ç»“æ„ã€ä¸‹è½½çŠ¶æ€å¸¸é‡ |
| `core/shared/utils.go` | å·¥å…·å‡½æ•° | MD5ã€åŸŸåæå–ã€æ–‡ä»¶åå¤„ç† |
| `core/shared/const.go` | å¸¸é‡å®šä¹‰ | ä¸‹è½½çŠ¶æ€ã€é”™è¯¯ç ç­‰ |

### 8.5 å‰ç«¯æ–‡ä»¶

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `frontend/src/main.ts` | å‰ç«¯å…¥å£ã€Wails åˆå§‹åŒ– |
| `frontend/src/App.vue` | æ ¹ç»„ä»¶ |
| `frontend/src/stores/index.ts` | å…¨å±€çŠ¶æ€ï¼ˆåº”ç”¨ä¿¡æ¯ã€é…ç½®ï¼‰ |
| `frontend/src/stores/event.ts` | äº‹ä»¶å¤„ç†ï¼ˆæ–°èµ„æºã€ä¸‹è½½è¿›åº¦ï¼‰ |
| `frontend/src/views/index.vue` | ä¸»é¡µé¢ï¼ˆèµ„æºåˆ—è¡¨ï¼‰ |
| `frontend/src/views/setting.vue` | è®¾ç½®é¡µï¼ˆé…ç½®ç®¡ç†ï¼‰ |
| `frontend/src/api/request.ts` | HTTP å®¢æˆ·ç«¯é…ç½® |
| `frontend/src/router/index.ts` | è·¯ç”±é…ç½® |
| `frontend/src/components/Sider.vue` | ä¾§è¾¹æ å¯¼èˆª |
| `frontend/src/locales/` | å›½é™…åŒ–ç¿»è¯‘ï¼ˆzh/enï¼‰ |

---

## ä¹ã€å¼€å‘ç¯å¢ƒæ­å»º

### 9.1 å‰ç½®è¦æ±‚

| è½¯ä»¶ | ç‰ˆæœ¬è¦æ±‚ | ç”¨é€” |
|------|----------|------|
| **Go** | 1.22+ | åç«¯å¼€å‘ |
| **Node.js** | 16+ | å‰ç«¯å¼€å‘ |
| **npm/pnpm** | æœ€æ–° | åŒ…ç®¡ç† |
| **Wails CLI** | æœ€æ–° | æ¡Œé¢åº”ç”¨æ¡†æ¶ |
| **Git** | æœ€æ–° | ç‰ˆæœ¬æ§åˆ¶ |

### 9.2 å®‰è£…æ­¥éª¤

#### æ­¥éª¤ 1: å®‰è£… Go

**Windows**:
```bash
# ä¸‹è½½å®‰è£…åŒ…
# https://go.dev/dl/

# éªŒè¯å®‰è£…
go version
```

**macOS**:
```bash
brew install go
```

**Linux**:
```bash
sudo apt install golang-go
# æˆ–
wget https://go.dev/dl/go1.22.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.22.linux-amd64.tar.gz
```

#### æ­¥éª¤ 2: å®‰è£… Node.js

**Windows**:
```bash
# ä¸‹è½½å®‰è£…åŒ…
# https://nodejs.org/

# éªŒè¯å®‰è£…
node -v
npm -v
```

**macOS**:
```bash
brew install node
```

**Linux**:
```bash
sudo apt install nodejs npm
```

#### æ­¥éª¤ 3: å®‰è£… Wails CLI

```bash
go install github.com/wailsapp/wails/v2/cmd/wails@latest

# éªŒè¯å®‰è£…
wails version
```

#### æ­¥éª¤ 4: å…‹éš†é¡¹ç›®

```bash
git clone https://github.com/putyy/res-downloader.git
cd res-downloader
```

#### æ­¥éª¤ 5: å®‰è£…å‰ç«¯ä¾èµ–

```bash
cd frontend
npm install
# æˆ–
pnpm install
cd ..
```

### 9.3 å¼€å‘æ¨¡å¼

```bash
# å¯åŠ¨å¼€å‘æ¨¡å¼ï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰
wails dev

# å‰ç«¯å•ç‹¬è¿è¡Œ
cd frontend
npm run dev

# åç«¯å•ç‹¬è¿è¡Œï¼ˆéœ€è¦å…ˆç¼–è¯‘å‰ç«¯ï¼‰
wails build -clean
./res-downloader  # Windows: res-downloader.exe
```

### 9.4 ç¼–è¯‘ç”Ÿäº§ç‰ˆæœ¬

```bash
# ç¼–è¯‘å½“å‰å¹³å°
wails build

# ç¼–è¯‘ç‰¹å®šå¹³å°
wails build -platform windows/amd64
wails build -platform darwin/amd64
wails build -platform darwin/arm64
wails build -platform linux/amd64

# è¾“å‡ºä½ç½®
# Windows: ./build/bin/res-downloader.exe
# macOS: ./build/bin/res-downloader.app
# Linux: ./build/bin/res-downloader
```

### 9.5 ç›®å½•ç»“æ„

```
res-downloader/
â”œâ”€â”€ main.go                    # Go å…¥å£
â”œâ”€â”€ go.mod                     # Go ä¾èµ–
â”œâ”€â”€ go.sum                     # Go ä¾èµ–é”å®š
â”œâ”€â”€ wails.json                 # Wails é…ç½®
â”œâ”€â”€ CLAUDE.md                  # Claude Code æŒ‡å¯¼
â”œâ”€â”€ é¡¹ç›®æ·±åº¦åˆ†ææŠ¥å‘Š.md           # æœ¬æŠ¥å‘Š
â”‚
â”œâ”€â”€ core/                      # Go åç«¯ä»£ç 
â”‚   â”œâ”€â”€ app.go                 # åº”ç”¨å•ä¾‹
â”‚   â”œâ”€â”€ proxy.go               # ä»£ç†æœåŠ¡å™¨
â”‚   â”œâ”€â”€ http.go                # HTTP API
â”‚   â”œâ”€â”€ downloader.go          # ä¸‹è½½å¼•æ“
â”‚   â”œâ”€â”€ resource.go            # èµ„æºç®¡ç†
â”‚   â”œâ”€â”€ config.go              # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ rule.go                # è§„åˆ™å¼•æ“
â”‚   â”œâ”€â”€ logger.go              # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”œâ”€â”€ storage.go             # å­˜å‚¨å±‚
â”‚   â”œâ”€â”€ bind.go                # Wails ç»‘å®š
â”‚   â”œâ”€â”€ aes.go                 # AES åŠ å¯†
â”‚   â”œâ”€â”€ utils.go               # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ middleware.go          # ä¸­é—´ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ plugins/               # æ’ä»¶ç›®å½•
â”‚   â”‚   â”œâ”€â”€ plugin.default.go  # é»˜è®¤æ’ä»¶
â”‚   â”‚   â””â”€â”€ plugin.qq.com.go   # QQ/å¾®ä¿¡æ’ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ shared/                # å…±äº«ä»£ç 
â”‚   â”‚   â”œâ”€â”€ plugin.go          # æ’ä»¶æ¥å£
â”‚   â”‚   â”œâ”€â”€ base.go            # åŸºç¡€ç±»å‹
â”‚   â”‚   â”œâ”€â”€ utils.go           # å·¥å…·å‡½æ•°
â”‚   â”‚   â””â”€â”€ const.go           # å¸¸é‡å®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ system.go              # ç³»ç»Ÿé›†æˆï¼ˆé€šç”¨ï¼‰
â”‚   â”œâ”€â”€ system_windows.go      # Windows é›†æˆ
â”‚   â”œâ”€â”€ system_darwin.go       # macOS é›†æˆ
â”‚   â””â”€â”€ system_linux.go        # Linux é›†æˆ
â”‚
â”œâ”€â”€ frontend/                  # Vue å‰ç«¯ä»£ç 
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ main.ts            # å‰ç«¯å…¥å£
â”‚   â”‚   â”œâ”€â”€ App.vue            # æ ¹ç»„ä»¶
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ views/             # é¡µé¢ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ index.vue      # ä¸»é¡µé¢
â”‚   â”‚   â”‚   â””â”€â”€ setting.vue    # è®¾ç½®é¡µ
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ components/        # å¯å¤ç”¨ç»„ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ Sider.vue      # ä¾§è¾¹æ 
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ stores/            # Pinia çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts       # å…¨å±€çŠ¶æ€
â”‚   â”‚   â”‚   â””â”€â”€ event.ts       # äº‹ä»¶å¤„ç†
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ api/               # API å±‚
â”‚   â”‚   â”‚   â””â”€â”€ request.ts     # HTTP å®¢æˆ·ç«¯
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ router/            # è·¯ç”±é…ç½®
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ locales/           # å›½é™…åŒ–
â”‚   â”‚       â”œâ”€â”€ zh.json        # ä¸­æ–‡
â”‚   â”‚       â””â”€â”€ en.json        # è‹±æ–‡
â”‚   â”‚
â”‚   â”œâ”€â”€ package.json           # å‰ç«¯ä¾èµ–
â”‚   â”œâ”€â”€ vite.config.ts         # Vite é…ç½®
â”‚   â””â”€â”€ tsconfig.json          # TypeScript é…ç½®
â”‚
â”œâ”€â”€ build/                     # æ„å»ºé…ç½®
â”‚   â”œâ”€â”€ appicon.png            # åº”ç”¨å›¾æ ‡
â”‚   â”œâ”€â”€ darwin/                # macOS æ„å»º
â”‚   â”œâ”€â”€ linux/                 # Linux æ„å»º
â”‚   â””â”€â”€ windows/               # Windows æ„å»º
â”‚
â””â”€â”€ wails.json                 # Wails é…ç½®
```

---

## åã€å¸¸è§é—®é¢˜è§£ç­”

### Q1: ä¸ºä»€ä¹ˆéœ€è¦å®‰è£…è¯ä¹¦ï¼Ÿ

**A**: ä¸ºäº†è§£å¯† HTTPS æµé‡ï¼ˆMITMï¼‰ã€‚åº”ç”¨ä½¿ç”¨è‡ªç­¾å CA è¯ä¹¦ï¼Œéœ€è¦å®‰è£…åˆ°ç³»ç»Ÿä¿¡ä»»é“¾æ‰èƒ½è®©æµè§ˆå™¨ä¿¡ä»»ã€‚

**å®‰è£…æµç¨‹**ï¼š
1. é¦–æ¬¡è¿è¡Œæ—¶ï¼Œå¯¼å‡ºè¯ä¹¦åˆ° `~/.config/res-downloader/cert.crt`
2. è°ƒç”¨ç³»ç»Ÿ API å®‰è£…åˆ°è¯ä¹¦å­˜å‚¨
3. åˆ›å»ºé”æ–‡ä»¶æ ‡è®°å®‰è£…å®Œæˆ

**è¯ä¹¦ä½ç½®**ï¼š
- **Windows**: å—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„ â†’ "gowas.cn"
- **macOS**: Keychain Access â†’ System â†’ Certificates
- **Linux**: /usr/local/share/ca-certificates/

### Q2: å¦‚ä½•å¤„ç†ç‰¹å®šåŸŸåçš„èµ„æºï¼Ÿ

**A**: åˆ›å»ºæ–°æ’ä»¶å®ç° Plugin æ¥å£ï¼Œåœ¨ OnResponse ä¸­è‡ªå®šä¹‰é€»è¾‘ã€‚

**ç¤ºä¾‹**ï¼š
```go
type CustomPlugin struct{}

func (p *CustomPlugin) OnResponse(resp *http.Response, ctx *goproxy.ProxyCtx) *http.Response {
    // è‡ªå®šä¹‰èµ„æºæ£€æµ‹é€»è¾‘
    // 1. æ£€æŸ¥ Content-Type
    // 2. æå–èµ„æºä¿¡æ¯
    // 3. åˆ›å»º MediaInfo
    // 4. å‘é€äº‹ä»¶
    return resp
}
```

### Q3: ä¸‹è½½å¤±è´¥å¦‚ä½•æ’æŸ¥ï¼Ÿ

**A**: æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼Œæ£€æŸ¥ä»¥ä¸‹æ–¹é¢ï¼š

1. **æ—¥å¿—ä½ç½®**: `~/.config/res-downloader/logs/`
2. **æ£€æŸ¥é¡¹**ï¼š
   - ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
   - ç›®æ ‡ URL æ˜¯å¦å¯è®¿é—®
   - Headers è®¾ç½®æ˜¯å¦æ­£ç¡®
   - Referer æ˜¯å¦æ­£ç¡®
   - æ–‡ä»¶ä¿å­˜è·¯å¾„æ˜¯å¦æœ‰æƒé™
3. **å¸¸è§é”™è¯¯**ï¼š
   - "HEAD request failed" â†’ URL ä¸å¯è®¿é—®æˆ–è¢«å¢™
   - "server does not support range requests" â†’ è‡ªåŠ¨é™çº§ä¸ºå•çº¿ç¨‹
   - "file open failed" â†’ ä¿å­˜è·¯å¾„ä¸å­˜åœ¨æˆ–æ— æƒé™

### Q4: å¦‚ä½•æ·»åŠ æ–°çš„ä¸‹è½½åè®®æ”¯æŒï¼Ÿ

**A**: åœ¨æ’ä»¶ä¸­æ£€æµ‹åè®®ç±»å‹ï¼Œåˆ›å»ºè‡ªå®šä¹‰ä¸‹è½½é€»è¾‘ã€‚

**ç¤ºä¾‹**ï¼š
```go
func (r *Resource) download(mediaInfo shared.MediaInfo, decodeStr string) {
    // æ£€æµ‹åè®®
    if strings.HasPrefix(mediaInfo.Url, "magnet:") {
        // BitTorrent ä¸‹è½½
        go r.downloadTorrent(mediaInfo)
    } else if strings.HasSuffix(mediaInfo.Url, ".m3u8") {
        // HLS æµåª’ä½“ä¸‹è½½
        go r.downloadHLS(mediaInfo)
    } else {
        // æ™®é€š HTTP/HTTPS ä¸‹è½½
        go r.downloadHTTP(mediaInfo, decodeStr)
    }
}
```

### Q5: å‰ç«¯å¦‚ä½•æ¥æ”¶åç«¯å®æ—¶æ›´æ–°ï¼Ÿ

**A**: é€šè¿‡ Wails EventsOn ç›‘å¬ "event" äº‹ä»¶ï¼Œåç«¯ç”¨ EventsEmit å‘é€ã€‚

**ç¤ºä¾‹**ï¼š
```typescript
// å‰ç«¯
EventsOn("event", (msg: string) => {
    const { type, data } = JSON.parse(msg)
    if (type === "newResources") {
        console.log("New resource:", data)
    }
})

// åç«¯
httpServerOnce.send("newResources", mediaInfo)
// å†…éƒ¨è°ƒç”¨: runtime.EventsEmit("event", jsonData)
```

### Q6: å¦‚ä½•ä¼˜åŒ–ä¸‹è½½é€Ÿåº¦ï¼Ÿ

**A**: è°ƒæ•´ä»¥ä¸‹é…ç½®ï¼š

1. **å¹¶å‘æ•°**: å¢åŠ é…ç½®ä¸­çš„ `TaskNumber`ï¼ˆé»˜è®¤ CPU æ ¸å¿ƒæ•° Ã— 2ï¼‰
2. **åŒæ—¶ä¸‹è½½æ•°**: å¢åŠ  `DownNumber`ï¼ˆé»˜è®¤ 3ï¼‰
3. **ç½‘ç»œç¯å¢ƒ**:
   - ä½¿ç”¨æœ‰çº¿ç½‘ç»œ
   - å…³é—­å…¶ä»–å ç”¨å¸¦å®½çš„ç¨‹åº
   - é…ç½®ä¸Šæ¸¸ä»£ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰
4. **æœåŠ¡å™¨é™åˆ¶**: æŸäº›æœåŠ¡å™¨é™åˆ¶å• IP è¿æ¥æ•°ï¼Œå¯ä»¥ï¼š
   - é™ä½å¹¶å‘æ•°
   - ä½¿ç”¨ä»£ç†æ± 
   - æ·»åŠ å»¶è¿Ÿ

### Q7: å¦‚ä½•é¿å…è¢«å°ç¦ï¼Ÿ

**A**: é‡‡å–ä»¥ä¸‹æªæ–½ï¼š

1. **é™åˆ¶ä¸‹è½½é€Ÿåº¦**: åœ¨ downloader.go ä¸­æ·»åŠ é€Ÿåº¦é™åˆ¶
2. **è®¾ç½® User-Agent**: æ¨¡æ‹ŸçœŸå®æµè§ˆå™¨
3. **è®¾ç½® Referer**: ä»æ­£å¸¸é¡µé¢è·³è½¬
4. **æ§åˆ¶å¹¶å‘**: ä¸è¦åŒæ—¶ä¸‹è½½å¤ªå¤šæ–‡ä»¶
5. **ä½¿ç”¨å»¶è¿Ÿ**: åœ¨ä¸‹è½½ä¹‹é—´æ·»åŠ éšæœºå»¶è¿Ÿ
6. **éµå®ˆ robots.txt**: å°Šé‡ç½‘ç«™çš„çˆ¬è™«è§„åˆ™

### Q8: å¦‚ä½•æ”¯æŒæ›´å¤šçš„è§†é¢‘å¹³å°ï¼Ÿ

**A**: åˆ†æç›®æ ‡å¹³å°çš„èµ„æºåŠ è½½æ–¹å¼ï¼Œé€‰æ‹©åˆé€‚çš„ç­–ç•¥ï¼š

1. **ç›´æ¥èµ„æº URL**ï¼ˆå¦‚æŠ–éŸ³ï¼‰:
   - æ£€æŸ¥ Content-Type: video/mp4
   - ä½¿ç”¨ DefaultPlugin

2. **åŠ å¯†èµ„æº**ï¼ˆå¦‚å¾®ä¿¡ï¼‰:
   - åˆ†æåŠ å¯†é€»è¾‘
   - æå–å¯†é’¥
   - ä¸‹è½½åè§£å¯†

3. **JS åŠ¨æ€åŠ è½½**ï¼ˆå¦‚å¿«æ‰‹ï¼‰:
   - æ³¨å…¥ JS ä»£ç 
   - æ‹¦æˆªèµ„æºå¯¹è±¡
   - å‘é€åˆ°ä»£ç†

4. **éœ€è¦ç™»å½•**:
   - è·å–ç™»å½• Cookie
   - åœ¨ä¸‹è½½æ—¶é™„åŠ  Cookie

### Q9: å¦‚ä½•å®ç°æ–­ç‚¹ç»­ä¼ ï¼Ÿ

**A**: å½“å‰å®ç°æ”¯æŒåŸºäº HTTP Range çš„æ–­ç‚¹ç»­ä¼ ï¼š

1. **å·²å®ç°**:
   - åˆ†ç‰‡ä¸‹è½½æ”¯æŒæ–­ç‚¹ï¼ˆæ¯ä¸ªåˆ†ç‰‡ç‹¬ç«‹é‡è¯•ï¼‰
   - æ–‡ä»¶é¢„åˆ†é…ï¼ˆé¿å…ç¢ç‰‡ï¼‰
   - ä¸‹è½½å¤±è´¥è‡ªåŠ¨é‡è¯•

2. **æ”¹è¿›æ–¹å‘**:
   - ä¿å­˜ä¸‹è½½è¿›åº¦åˆ°æ–‡ä»¶
   - é‡å¯æ—¶æ¢å¤è¿›åº¦
   - æ”¯æŒæš‚åœ/æ¢å¤

### Q10: å¦‚ä½•æ‰“åŒ…å‘å¸ƒï¼Ÿ

**A**: ä½¿ç”¨ Wails æ‰“åŒ…ï¼š

```bash
# ç¼–è¯‘
wails build

# ç­¾åï¼ˆmacOSï¼‰
codesign --deep --force --verify --verbose --sign "Developer ID Application: Your Name" ./build/bin/res-downloader.app

# å…¬è¯ï¼ˆmacOSï¼‰
xcrun notarytool submit ./build/bin/res-downloader.app --apple-id "your@email.com" --password "app-specific-password" --team-id "TEAM_ID" --wait

# åˆ›å»ºå®‰è£…åŒ…ï¼ˆWindowsï¼‰
# ä½¿ç”¨ Inno Setup æˆ– NSIS

# å‘å¸ƒåˆ° GitHub
gh release create v1.0.0 ./build/bin/res-downloader.exe
```

---

## é™„å½•

### A. é…ç½®æ–‡ä»¶ç¤ºä¾‹

```json
{
  "Theme": "lightTheme",
  "Locale": "zh",
  "Host": "127.0.0.1",
  "Port": "8899",
  "Quality": 0,
  "SaveDirectory": "/Users/xxx/Downloads",
  "FilenameLen": 0,
  "FilenameTime": true,
  "UpstreamProxy": "",
  "OpenProxy": false,
  "DownloadProxy": false,
  "AutoProxy": false,
  "WxAction": true,
  "TaskNumber": 16,
  "DownNumber": 3,
  "UserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
  "UseHeaders": "default",
  "InsertTail": true,
  "MimeMap": {
    "video/mp4": {"Type": "video", "Suffix": ".mp4"},
    "image/png": {"Type": "image", "Suffix": ".png"}
  },
  "Rule": "*\n!google.com\n*.qq.com"
}
```

### B. äº‹ä»¶æ•°æ®ç»“æ„

```typescript
// æ–°èµ„æºäº‹ä»¶
interface NewResourcesEvent {
    type: "newResources"
    data: {
        Id: string
        Url: string
        UrlSign: string
        CoverUrl: string
        Size: number
        Domain: string
        Classify: string  // "video" | "audio" | "image" | ...
        Suffix: string
        Status: string  // "Ready" | "Running" | "Done" | "Error"
        SavePath: string
        ContentType: string
        DecodeKey: string
        OtherData: {
            headers?: string
            wx_file_formats?: string
        }
        Description: string
    }
}

// ä¸‹è½½è¿›åº¦äº‹ä»¶
interface DownloadProgressEvent {
    type: "downloadProgress"
    data: {
        Id: string
        Status: string
        SavePath: string
        Message: string  // "45%" | "error message" | "complete"
    }
}

// æ¶ˆæ¯äº‹ä»¶
interface MessageEvent {
    type: "message"
    data: {
        type: "success" | "error" | "warning" | "info"
        content: string
    }
}
```

### C. API ç«¯ç‚¹æ±‡æ€»

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | è¯·æ±‚ä½“ | å“åº” |
|------|------|------|--------|------|
| `/api/install` | POST | å®‰è£…ç³»ç»Ÿç»„ä»¶ | - | `{code, message}` |
| `/api/download` | POST | å¼€å§‹ä¸‹è½½ | `MediaInfo` | `{code, message}` |
| `/api/cancel` | POST | å–æ¶ˆä¸‹è½½ | `{id}` | `{code, message}` |
| `/api/set-config` | POST | æ›´æ–°é…ç½® | `Config` | `{code, message}` |
| `/api/proxy-open` | POST | å¼€å¯ä»£ç† | - | `{code, message}` |
| `/api/proxy-unset` | POST | å…³é—­ä»£ç† | - | `{code, message}` |
| `/api/set-res-type` | POST | è®¾ç½®èµ„æºç±»å‹ | `{types}` | `{code, message}` |
| `/api/get-marked` | POST | è·å–å·²æ ‡è®°èµ„æº | - | `MediaInfo[]` |

### D. å‚è€ƒèµ„æº

- **Wails å®˜æ–¹æ–‡æ¡£**: https://wails.io/docs/next/introduction
- **goproxy GitHub**: https://github.com/elazarl/goproxy
- **Vue 3 å®˜æ–¹æ–‡æ¡£**: https://cn.vuejs.org/
- **Naive UI å®˜æ–¹æ–‡æ¡£**: https://www.naiveui.com/
- **Go æ ‡å‡†åº“**: https://pkg.go.dev/std

---

## æŠ¥å‘Šç»“æŸ

**æŠ¥å‘Šç‰ˆæœ¬**: 1.0
**ç”Ÿæˆæ—¥æœŸ**: 2026-01-27
**æŠ¥å‘Šä½œè€…**: Claude Code
**é¡¹ç›®ä»“åº“**: https://github.com/putyy/res-downloader

**åé¦ˆä¸è´¡çŒ®**:
å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issue æˆ– Pull Request åˆ°é¡¹ç›®ä»“åº“ã€‚

---

**ç‰ˆæƒå£°æ˜**:
æœ¬æŠ¥å‘ŠåŸºäº res-downloader é¡¹ç›®ä»£ç åˆ†æç”Ÿæˆï¼Œéµå¾ªé¡¹ç›®åŸæœ‰çš„å¼€æºè®¸å¯è¯ã€‚
